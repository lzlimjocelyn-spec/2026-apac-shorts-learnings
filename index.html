<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APAC 2026 Planning Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF.js for PDF Text Extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- LocalForage for Offline Storage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
       import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global Firebase state
        window.firebaseDB = null;
        window.firebaseAuth = null;
        window.firebaseStorage = null;
        window.repoCollectionRef = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Use environment configuration
 const firebaseConfig = {
  apiKey: "AIzaSyAqUFv2ECSUjYdcUbxTHL3ciPt4d1AW9FI",
  authDomain: "apac-shorts.firebaseapp.com",
  projectId: "apac-shorts",
  storageBucket: "apac-shorts.firebasestorage.app",
  messagingSenderId: "119416626919",
  appId: "1:119416626919:web:865aaa1f198d44da864c42",
  measurementId: "G-W636G302N1"
};

        if (firebaseConfig) {
            try {
                   const app = initializeApp(firebaseConfig);
                  const analytics = getAnalytics(app);
                window.firebaseAuth = getAuth(app);
                window.firebaseDB = getFirestore(app);
                window.firebaseStorage = getStorage(app);
                
                const initAuth = async () => {
                    try {
                        // ALWAYS use the environment tokens when available
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.firebaseAuth, __initial_auth_token);
                        } else {
                             await signInAnonymously(window.firebaseAuth);
                        }
                    } catch (authError) {
                        console.error("Auth failed:", authError);
                        // Fallback attempt
                        try { 
                            if (!window.firebaseAuth.currentUser) {
                                await signInAnonymously(window.firebaseAuth); 
                            }
                        } catch(e) { 
                            console.error("Anonymous Auth Fallback Failed:", e); 
                        }
                    }
                };
                
                initAuth();

                onAuthStateChanged(window.firebaseAuth, (user) => {
                    if (user) {
                        // Correct path structure: /artifacts/{appId}/public/data/{collectionName}
                        window.repoCollectionRef = collection(window.firebaseDB, 'artifacts', window.appId, 'public', 'data', 'repository');
                        initRepoListener();
                        const statusEl = document.getElementById('cloud-status');
                        if(statusEl) {
                            statusEl.innerHTML = '<span class="text-green-600 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Cloud Connected</span>';
                            statusEl.className = 'text-sm font-mono text-green-700 bg-green-50 px-3 py-1 rounded border border-green-200';
                        }
                    } else {
                        const statusEl = document.getElementById('cloud-status');
                        if(statusEl) {
                            statusEl.innerHTML = '<span class="text-amber-600">Connecting...</span>';
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
            }
        } else {
             const status = document.getElementById('cloud-status');
             if(status) status.innerText = 'Configuration Missing';
        }

        function initRepoListener() {
            if (!window.repoCollectionRef) return;
            // Listening for changes in the repository collection
            onSnapshot(window.repoCollectionRef, (snapshot) => {
                const repoData = { 'repo_campaign': [], 'repo_holdback': [], 'repo_kpop': [] };
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.category && repoData[data.category]) {
                        repoData[data.category].push({
                            id: doc.id,
                            name: data.name,
                            content: data.content,
                            storageUrl: data.storageUrl,
                            type: data.type,
                            date: data.date
                        });
                    }
                });
                if (window.updateRepoCacheFromCloud) {
                    window.updateRepoCacheFromCloud(repoData);
                }
            }, (error) => {
                console.error("Repository listener error:", error);
            });
        }

        window.saveToCloud = async (fileObj, category) => {
            if (!window.repoCollectionRef || !window.firebaseAuth.currentUser) return false;
            const docId = `${category}_${fileObj.name.replace(/[^a-z0-9]/gi, '_')}`;
            const docRef = doc(window.repoCollectionRef, docId);
            let downloadURL = null;
            let contentToSave = fileObj.content;

            // Optional Storage usage if configured
            if (window.firebaseStorage) {
                try {
                    const storageRef = ref(window.firebaseStorage, `repository/${window.appId}/${docId}`);
                    await uploadString(storageRef, fileObj.content);
                    downloadURL = await getDownloadURL(storageRef);
                    contentToSave = null; 
                } catch (storageError) {
                    // Fallback to Firestore direct if Storage is restricted
                    if (fileObj.content.length > 900000) return false;
                    contentToSave = fileObj.content;
                }
            } else if (fileObj.content.length > 900000) {
                 return false;
            }

            try {
                await setDoc(docRef, {
                    name: fileObj.name,
                    content: contentToSave,
                    storageUrl: downloadURL,
                    type: fileObj.type,
                    category: category,
                    date: new Date().toLocaleDateString()
                });
                return true;
            } catch (e) { 
                console.error("Save to Cloud failed:", e);
                return false; 
            }
        };

        window.deleteFromCloud = async (docId) => {
             if (!window.repoCollectionRef) return;
             try { await deleteDoc(doc(window.repoCollectionRef, docId)); } catch (e) { console.error("Delete failed:", e); }
        };
    </script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        .sub-tab-btn { color: #6b7280; border-bottom: 2px solid transparent; }
        .sub-tab-btn:hover { color: #374151; border-bottom: 2px solid #d1d5db; }
        .sub-tab-btn.active { color: #2563eb !important; border-bottom: 2px solid #2563eb !important; font-weight: 600; }
        .repo-tab-content { display: none; }
        .repo-tab-content.active { display: block; }
        .repo-tab-btn.active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; font-weight: 600; }
        .table-container { overflow-x: auto; position: relative; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: white; max-height: 75vh; overflow-y: auto; }
        .table-container::-webkit-scrollbar { height: 12px; width: 12px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 6px; border: 3px solid white; }
        .table-container::-webkit-scrollbar-track { background-color: #f1f5f9; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th, td { border-bottom: 1px solid #e5e7eb; padding: 0.75rem 0.5rem; white-space: nowrap; font-size: 0.75rem; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; }
        th.sticky-col:last-child, td.sticky-col:last-child { box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.05); border-right: 1px solid #e5e7eb; }
        .table-container thead { position: sticky; top: 0; z-index: 30; background-color: #f8fafc; }
        .table-container thead th { font-weight: 600 !important; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; background-color: #f8fafc; }
        .table-container thead th.sticky-col { z-index: 40; background-color: #f8fafc; }
        tbody tr:hover td { background-color: #f8fafc; }
        tbody tr:hover td.sticky-col { background-color: #f8fafc; }
        .color-sig-pos { color: #10B981; font-weight: 700; background-color: #ecfdf5 !important; }
        .color-sig-neg { color: #EF4444; font-weight: 700; background-color: #fef2f2 !important; }
        .color-sig-neutral { color: #334155; }
        .color-na { color: #94a3b8; font-style: italic; font-size: 0.8em;}
        .markdown-content { line-height: 1.7; color: #334155; max-width: 100%; }
        .markdown-content h1 { font-size: 2rem; font-weight: 800; margin-bottom: 1.5rem; margin-top: 2rem; color: #1e3a8a; border-bottom: 2px solid #bfdbfe; padding-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2.5rem; margin-bottom: 1.25rem; color: #1e293b; border-left: 4px solid #2563eb; padding-left: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem; background: #f8fafc; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 1rem; color: #1e40af; border-bottom: 2px solid #e0e7ff; padding-bottom: 0.5rem; }
        .markdown-content h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1.25rem; color: #4b5563; }
        .markdown-content p { margin-bottom: 1rem; }
        .markdown-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.25rem; }
        .markdown-content li { margin-bottom: 0.5rem; }
        .markdown-content strong { color: #0f172a; font-weight: 700; }
        .sig-green { color: #16a34a; font-weight: 700; }
        .sig-red { color: #dc2626; font-weight: 700; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; font-size: 0.85rem; border: 1px solid #cbd5e1; table-layout: auto; }
        .markdown-content th, .markdown-content td { border: 1px solid #cbd5e1; padding: 0.75rem; text-align: left; vertical-align: top; white-space: normal; word-wrap: break-word; }
        .markdown-content th { background-color: #f1f5f9; font-weight: 700; color: #0f172a; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 2px solid #94a3b8; }
        .markdown-content tr:nth-child(even) { background-color: #f8fafc; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-6"></div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">APAC Dashboard 2026</h2>
        <p id="loading-text" class="text-gray-500 font-medium">Connecting to Cloud Repository...</p>
    </div>

    <div class="w-full max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">APAC 2026 Planning Dashboard</h1>
                <p class="text-slate-500 mt-1">Shorts Campaign Analysis & Strategic Planning</p>
            </div>
            <div id="cloud-status" class="text-sm font-mono text-gray-500 bg-white px-3 py-1 rounded border">Connecting...</div>
        </header>

        <!-- File Upload Section -->
        <div id="upload-section" class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8 text-center hidden fade-in">
            <div class="max-w-4xl mx-auto">
                <div class="mx-auto h-16 w-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" /></svg>
                </div>
                <div class="flex justify-center items-center gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Upload Data Sources</h2>
                    <a href="https://drive.google.com/drive/folders/1XV5hPMzgNRk-xAs1LDVwhxjQw30rAWXa?resourcekey=0-oAISdPdQj-T1HTYxwq_aNg&usp=drive_link" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-full text-xs font-medium transition border border-blue-200">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.01 1.984c-1.396 0-2.61.76-3.3 1.91L.775 17.848a3.86 3.86 0 000 3.82c.66 1.157 1.88 1.905 3.286 1.922h15.895c1.405-.018 2.624-.766 3.284-1.922a3.86 3.86 0 000-3.82L15.31 3.894a3.86 3.86 0 00-3.3-1.91zM4.686 18.23l4.312-7.483 4.34 7.484H4.685zm8.685 0l-4.34-7.483 4.32-7.525 4.35 7.476-4.33 7.532z"/></svg>Open Drive Folder
                    </a>
                </div>
                <p class="text-gray-500 mb-8">Upload new files to automatically sync them to the Cloud Data Repository.</p>

                <div class="grid md:grid-cols-3 gap-6 mb-8 text-left">
                    <div class="border border-gray-200 p-5 rounded-lg bg-gray-50 hover:bg-white hover:shadow-md transition group">
                        <div class="flex items-center gap-2 mb-3"><div class="h-6 w-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">1</div><h3 class="font-bold text-gray-900">Campaign Data</h3></div>
                        <p class="text-xs text-gray-500 mb-3">Upload "Shorts HB Input" CSVs & "Fact Pack" PDF.</p>
                        <input type="file" id="campaignFileInput" multiple accept=".csv, .pdf" class="block w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer"/>
                    </div>
                    <div class="border border-gray-200 p-5 rounded-lg bg-gray-50 hover:bg-white hover:shadow-md transition group">
                        <div class="flex items-center gap-2 mb-3"><div class="h-6 w-6 rounded bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xs">2</div><h3 class="font-bold text-gray-900">Global Holdback</h3></div>
                        <p class="text-xs text-gray-500 mb-3">Upload "Global Shorts HB" CSV files.</p>
                        <input type="file" id="holdbackFileInput" multiple accept=".csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer"/>
                    </div>
                    <div class="border border-gray-200 p-5 rounded-lg bg-gray-50 hover:bg-white hover:shadow-md transition group">
                        <div class="flex items-center gap-2 mb-3"><div class="h-6 w-6 rounded bg-pink-100 text-pink-600 flex items-center justify-center font-bold text-xs">3</div><h3 class="font-bold text-gray-900">K-Pop Data</h3></div>
                        <p class="text-xs text-gray-500 mb-3">Upload KPop Data and Dates CSV files.</p>
                        <input type="file" id="kpopFileInput" multiple accept=".csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-pink-600 file:text-white hover:file:bg-pink-700 cursor-pointer"/>
                    </div>
                </div>

                <div class="mt-8 pt-8 border-t border-gray-200 text-left">
                    <div class="flex justify-between items-end mb-4">
                        <div><h3 class="text-lg font-bold text-gray-800">Cloud Data Repository</h3><p class="text-xs text-gray-500">Files below are saved permanently in the cloud (Firebase). Check box to include in analysis.</p></div>
                        <div class="flex items-center gap-2"><span id="sync-status" class="text-xs text-gray-400 italic">Syncing...</span><span id="repo-count-badge" class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-medium">0 files</span></div>
                    </div>
                    <div class="flex space-x-2 mb-4">
                        <button onclick="switchRepoTab('repo-campaign')" id="btn-repo-campaign" class="repo-tab-btn active px-4 py-2 text-sm rounded-md border border-gray-200 bg-white hover:bg-gray-50 transition">Campaign Data</button>
                        <button onclick="switchRepoTab('repo-holdback')" id="btn-repo-holdback" class="repo-tab-btn px-4 py-2 text-sm rounded-md border border-gray-200 bg-white hover:bg-gray-50 transition">Global Holdback</button>
                        <button onclick="switchRepoTab('repo-kpop')" id="btn-repo-kpop" class="repo-tab-btn px-4 py-2 text-sm rounded-md border border-gray-200 bg-white hover:bg-gray-50 transition">K-Pop Data</button>
                    </div>
                    <div class="bg-gray-50 rounded-lg border border-gray-200 p-4 min-h-[150px] max-h-[300px] overflow-y-auto">
                        <div id="repo-campaign" class="repo-tab-content active"><p class="text-center text-gray-400 text-sm py-8">Loading repository...</p></div>
                        <div id="repo-holdback" class="repo-tab-content"><p class="text-center text-gray-400 text-sm py-8">Loading repository...</p></div>
                        <div id="repo-kpop" class="repo-tab-content"><p class="text-center text-gray-400 text-sm py-8">Loading repository...</p></div>
                    </div>
                </div>
                
                <div class="flex flex-col items-center mt-8">
                    <button onclick="processFiles()" class="px-8 py-3 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Analyze Data (Uploads + Selected)</button>
                    <p id="status-msg" class="text-sm font-medium mt-4 h-6 transition-colors duration-300"></p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="hidden fade-in">
            <!-- Top Control Bar -->
            <div class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                <button onclick="showUploadSection()" class="flex items-center text-sm font-medium text-gray-600 hover:text-blue-700 transition px-3 py-1 rounded hover:bg-blue-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" /></svg>Add/Manage Data Sources
                </button>
                <div class="text-right flex items-center gap-3">
                    <div class="text-xs text-right"><span class="block text-green-600 font-bold uppercase tracking-wider text-[10px]">System Status</span><span id="data-source-indicator" class="text-gray-500 font-medium">Live Cloud Data</span></div>
                    <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
            </div>

            <!-- Sticky Nav & Filters -->
            <div class="border-b border-gray-200 mb-6 sticky top-0 bg-gray-100 z-50 pt-2 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center px-2 gap-4 pb-2">
                    <nav class="-mb-px flex space-x-1 overflow-x-auto pb-2" aria-label="Tabs">
                        <button onclick="switchTab('tab4')" id="btn-tab4" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-800 hover:border-gray-300 transition">Global HB Summary</button>
                        <button onclick="switchTab('tab1')" id="btn-tab1" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-800 hover:border-gray-300 transition">Campaign HB Regional</button>
                        <button onclick="switchTab('tab5')" id="btn-tab5" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-800 hover:border-gray-300 transition">KPop Analysis</button>
                        <button onclick="switchTab('tab2')" id="btn-tab2" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-800 hover:border-gray-300 transition">Key Learnings</button>
                        <button onclick="switchTab('tab3')" id="btn-tab3" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-800 hover:border-gray-300 transition">Year Ahead 2026</button>
                    </nav>
                    
                    <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-md border border-gray-200 shadow-sm mb-2 md:mb-0">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Show:</span>
                        <button onclick="updateMetricView('both')" id="mv-both" class="mv-btn text-xs font-medium px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition">Both</button>
                        <button onclick="updateMetricView('dau')" id="mv-dau" class="mv-btn text-xs font-medium px-2 py-1 rounded text-gray-600 hover:bg-gray-100 transition">DAU</button>
                        <button onclick="updateMetricView('dac')" id="mv-dac" class="mv-btn text-xs font-medium px-2 py-1 rounded text-gray-600 hover:bg-gray-100 transition">DAC</button>
                    </div>
                </div>
            </div>

            <div id="tab4" class="tab-content active bg-white p-6 rounded-lg shadow-sm border border-gray-200 min-h-[500px] fade-in">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-900">Global Shorts Holdback Data Summary</h2><span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">View: Monthly & Segmented</span></div>
                <div id="holdback-summary-output" class="text-gray-600"><div class="flex flex-col items-center justify-center h-64 text-gray-400"><p>No data loaded. Select files from the Repository or Upload.</p></div></div>
            </div>

            <div id="tab1" class="tab-content bg-white p-6 rounded-lg shadow-sm border border-gray-200 min-h-[500px] fade-in">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-900">Campaign HB Data Summary</h2><span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Metric: DAU & DAC SCT</span></div>
                <div id="summary-output" class="text-gray-600"></div>
            </div>

            <div id="tab5" class="tab-content bg-white p-6 rounded-lg shadow-sm border border-gray-200 min-h-[500px] fade-in">
                <h2 class="text-xl font-bold text-gray-900 mb-4">KPop Campaign HB Data Summary</h2>
                <div id="kpop-summary-output" class="text-gray-600"><div class="flex flex-col items-center justify-center h-64 text-gray-400"><p>Upload KPop Data and Date files to see summary here.</p></div></div>
            </div>

            <div id="tab2" class="tab-content bg-white p-6 rounded-lg shadow-sm border border-gray-200 min-h-[500px] fade-in">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
                    <div><h2 class="text-2xl font-bold text-gray-900">Key Learnings & Executive Summary</h2><p class="text-sm text-gray-500">Full PDF Report Content.</p></div>
                    <button onclick="copyToClipboard(this, 'learnings-output')" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition focus:outline-none">Copy Report</button>
                </div>
                <div id="learnings-output" class="text-gray-600 markdown-content bg-white"></div>
            </div>

            <div id="tab3" class="tab-content bg-white p-6 rounded-lg shadow-sm border border-gray-200 min-h-[500px] fade-in">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
                    <div><h2 class="text-2xl font-bold text-gray-900">Year Ahead Strategy Detail</h2><p class="text-sm text-gray-500">2026 Strategic Roadmap & Experimentation.</p></div>
                    <div class="flex gap-2">
                        <button onclick="copyToClipboard(this, 'year-ahead-output')" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition focus:outline-none">Copy Plan</button>
                    </div>
                </div>
                <div id="year-ahead-output" class="text-gray-600 markdown-content bg-white"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL STATE & CONSTANTS ---
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const GENDER_ORDER = ['Female', 'Male', 'GenPop']; 
        const AGE_ORDER = ['18-24', '25-34', '18-34', 'GenPop']; 
        const DAU_METRIC_COL_NAME = 'Daily Shorts Creation Tool Active Users'; 
        const DAC_METRIC_COL_NAME = 'Shorts DAC-SCT';

        const COUNTRY_EXCLUSIONS = {
            'IN': ["IN Beauty & Fashion CF1", "IN Beauty & Fashion CF2", "IN Beauty & Fashion", "Infinite S", "Travel CF1", "Travel CF2", "Travel HB", "Authentic Formats", "HL Food Non AI", "HL Food AI"],
            'ID': ["Pets", "Do It For the Plot", "Global UTS/MVR"],
            'JP': ["Pets", "Photos", "Infinite-S", "Autumn AI Human", "Autumn AI Non Human", "Autumn Non AI"],
            'KR': ["Pets", "Templates", "KR Trends Page", "Infinite-S", "Spring", "Summer CF1", "Summer CF2", "Summer CF3", "KR Summer"]
        };

        const MANUAL_LEARNINGS_CONTENT = `
# 2025 APAC Key Results & Learnings (Executive Summary)

**Executive Overview: The "Friction" & "Relevance" Game**

2025 proved that Global Scale alone fails in APAC. Success was exclusively driven when we successfully removed Psychological Friction (via templates and consistent low-friction formats rather than "tentpole Fireworks") or increased Cultural Utility (via hyper-local IP/gamification/local audio). There is also no perceived correlation for campaigns or country holdback observing DAC-SCT stat sig when DAU-SCT is also stat sig, most often if DAU-SCT is stat sig, DAC-SCT may or may not be stat sig, as it is a more down funnel metric vs DAU-SCT.

Reference link for live data: [lzlimjocelyn-spec.github.io/2026-apac-shorts-learnings/](https://Izlimjocelyn-spec.github.io/2026-apac-shorts-learnings/)

### 1. Overall APAC Performance (Global Holdback)

* **Positive Months:** April, July, October, November, December.
* **Drivers:** Consistent contribution from Hyperlocal Evergreen (Pets/Photos/Food/Arts & Craft) and Local Audio (UTS/MVR).
* **Exceptions:** Global BTMs only worked when heavily localized (Ed Sheeran JP, Alex Warren KR) or Gamified (F1 IN/KR), and when overlaid with "skill equalizer" feature/concept principles. Select GenAl features launched in Dec (Veo3 for ID and IN Arts & Craft) drove stat sig results, as well as Japan's seasonal winter campaign.
* **Negative Months:** No overall stat sig negative months for APAC (from Apr to Dec), but significant segment-level negatives in specific markets driven by Global BTMs and SSC. Reference to appendix data below.

### 2. What Worked: The Drivers of Momentum

#### 1. The "Skill Equalizer" (Low Friction Templates):

* **a. Insight:** Users want to create but fear low quality. Templates that use existing assets (Photos/Gallery assets) or Gen AI features remove this fear and lower the "quality" barrier. In Japan specifically, layering on local seasonal relevance (Winter/Christmas) also helps increase relevance for DAU-SCT interaction.
* **b. Proof (Campaign HB):**
    * **i.** Hyperlocal campaigns (**JP Photos:** JP Female 18-24: +2.88%, JP Female 18-34: +1.7%, JP Gen pop 18-24: +1.29%, JP Gen pop 18-34: +1.1%, **JP winter HL:** JP Female GenPop +1.8%, JP Male GenPop +1.08%, JP GenPop +0.77%, **ID Pets:** ID Gen pop 25-34: +0.26%, ID Gen pop 18-34: +0.23%, ID Gen pop: +0.26%, **IN Travel:** IN F25-34: +0.19%, IN F18-34: +1.7%, /**IN Food:** IN Gen pop 18-24: +0.12%/ **IN Arts & Crafts:** IN Gen pop 18-24: +0.12%, IN Male Gen Pop: +0.15%) consistently drove stat sig positive growth in the APAC Global Shorts Holdback, particularly in April, July, October, November and December.
    * **ii.** Select Global GenAl launches also proved effective for ID (**ID Global Gen Al - Veo 31 (Dec):** ID Female 18-34 +1.35%, ID Female GenPop +1%)

#### 2. Gamifying the "Male" Barrier:

* **a. Insight:** Young males do not "create content"; they "play games." Interactive effects tied to globally relevant Sports or Gaming IP help to bridge this gap, activating passive males.
* **b. Proof (Campaign HB):** IN F1 BTM (Male 18-34: +0.42%); KR F1 BTM (Male 18-24: +7.73%). Roblox gaming effects (ID Female Gen Pop: +0.53%).

#### 3. Audio "Drumbeats" (Consistent High Frequency Local Habits):

* **a. Insight:** Users build habits around consistent audio formats (UTS/MVR) rather than one-off artist drops to create habit loops.
* **b. Proof (Campaign HB):** KR UTS2 F18-34: +2.15%; IN MVR2 Gen Pop: +0.12%. In India, MVR ("remix" sound) significantly outperformed UTS ("use this sound") featuring the same artists, confirming that creation mechanic and feature preference alignment is critical.

#### 4. Global Artist Tentpoles with hyper-localization and "skill equalizer" principles

* **a. Insight:** The primary driver of a music campaign's success is not the artist's global fame, but the GTM execution's ability to provide a low-friction "container" for creation, with concepts customised for gender relevance (males vs females).
* **b. Proof (Campaign HB):** Ed Sheeran JP F18-34 +1.45% lift, used a template/photo dump mechanic anchored and relatable to local user behavior in JP. Alex Warren's BTM in Korea provided a "photobooth collage" effect and a "reminiscing fond memories" template, which led to KR F Gen pop +1.31% lift. Taylor Swift's BTM succeeded in Japan, yielding F Gen pop +1.99% lift, by offering a template for her dance trend and a custom "Showgirl" effect, making participation easy and relatable for females although irrelevant for JP males.

#### 5. Diversified K-pop creation ecosystem

* **a. Insight:** K-pop's influence in APAC is best harnessed by pivoting from high-friction "dance challenges" to a diversified creation ecosystem that includes non-dance trends (transitions, vlogs, pets) and custom artists branded effects. This expansion lowers entry barriers for non-core segments (Males globally, older Gen Pop) and sustains engagement beyond initial fandom spikes.
* **b. Proof (Campaign Holdback):** In Indonesia, non-dance concepts like fashion transitions and pet overlays unlocked DAU-SCT for young females (Baby Monster/Le Sserafim F18-34: +0.39%). In Japan, Aespa's non-dance creative engaged Male Gen Pop (+0.90%). The Aespa BTM drove DAU-SCT in Brazil (Male 25-34: +0.93%) and Germany (GenPop 25-34: +1.12%) by leveraging custom effects. The IDLE campaign's inclusion of non-dance/pet variants achieved a massive +3.27% lift for Males 18-24 in Germany.

#### 6. Strategic Optimization of Discovery Surfaces

* **a. Insight:** For trend discovery, the optimal surface is market-dependent: the Home feed Shelf format is effective for "pull" discovery in Japan, while the in-feed SSC format works for "push" discovery with specific male segments in India.
* **b. Proof (Campaign HB):** JP Shelf (Female 18-34 +1.50%, JP Gen Pop 25-34 +0.99%), IN SSC (Male 18-34: +0.13%).

## 3. What Didn't Work: The "Relevance" Gaps

#### 1. Generic Global or Kpop "Tentpoles" without Localization and "skill equalizer" principles:

* **a. Insight:** Global fame (Taylor Swift, Sabrina Carpenter) does not overcome high creation friction (complex dance challenges) or local relevance. Global BTMs are only effective when they include a low-friction template or effect mechanic (e.g., Ed Sheeran's photo dump template) customised by local relevance, gender or be gender agnostic.
* **b. Proof (Campaign HB):** Global BTMs that failed (**Taylor Swift in IN/ID/JP:** IN Female 18-24: -0.76%, ID Female 25-34 -0.48%, ID Male Gen pop: -0.39%, JP Male 18-24 (-4.25%), JP Male 18-34 (-2.2%), JP Male Gen pop (-1.68%); **Sabrina Carpenter BTM in KR/ID:** ID Male 18-24:-1.1%, KR Gen pop 18-24: -5.09%) relied on high-friction dance challenges without sufficient hyperlocalized template and concept support. In the US, MX, FR, UK, Aespa BTM failed for Males in the US (-0.49%) and Mexico (-2.04%), likely due to low male view-share or gender-misaligned creative. In France and the UK, even with high female views (66%), Aespa BTM was negative for females, suggesting "localization failure" where creatives felt inauthentic to Western users.

#### 2. Interruptive "Push" Formats in Mature Markets:

* **a. Insight:** Forcing trends into the feed (SSC) annoys deliberate users in mature markets (JP/KR).
* **b. Proof (Campaign HB):** SSC consistently negative in JP (F18-34 -1.07%) and KR (F25-34 -1.81%), whereas Shelf (Pull) was positive.

#### 3. Misaligned "Generic" Categories:

* **a. Insight:** "Authentic Formats" (OOTD/DIML), misaligned Sports IP or misaligned topics (Arts and Craft for ID) can feel generic and high-effort compared to culturally nuanced hooks.
* **b. Proof (Campaign HB):** India "Authentic Formats" drove -0.28% for Male 25-34. Indonesia Global GenAl Veo3 (ID Male GenPop -0.86%). Misaligned locally irrelevant Sports IP US Tennis Open ID (ID Male 25-34: -0.59%). Unpopular/misaligned ID Arts & Craft (Drawing Al effects) (ID Female 25-34-0.32%, ID Female 18-34-0.26%, ID female GenPop -0.28%)

## 4. Critical Implications for 2026

### 1. Global scaled BTMs and principles

* **a. Stop "Lift & Shift" with feature/concept integration mandate:** Global Artists BTMs must be launched with a mandatory dedicated, low-friction creation variant (e.g., custom template, Al effect, or gallery upload functionality) that aligns with local creation trends (e.g., photo dumps, collage) to maximize conversion or be deprioritized.
* **b. Global Inclusion of Non-Dance Mandate:** Mandate that all global K-Pop proactive campaigns include "low-friction" non-dance creative variants (transitions, pets, vlogs, photo dumps) to ensure scalability into Male and Gen Pop segments.
* **c. Localization Pre-Approval:** Establish a localization "authenticity check" for Western markets (EMEA/LATAM) to prevent the negative incrementality observed in FR/UK where high views did not convert to creation.

### 2. Feature Investment

* **a. Al Localization:** Invest heavily in Gen Al tools (e.g., Dream Drawing Al, as used in IN Arts & Crafts) to lower the creation barrier for high-effort categories, making advanced creative concepts accessible to Gen Pop.
* **b. Segment-Specific Effects:** Prioritize the rollout of high-production custom artist effects customised for gender or gender agnostic (e.g., Aespa Studio Effect) in markets with high male engagement like Brazil.

### 3. Surface/Format Prioritization

* **a. Surface Segmentation:** Kill SSC for Females in JP/KR immediately; migrate investment to Shelf. Keep SSC for Indian Males and optimize male-skewing hyperlocal trends.
* **b. Mandate FSI Conversion:** Utilize the FSI surface for all music-led creation conversions, leveraging its proven high-impact performance over other nitrate surfaces.

### 4. Content Double Clicks

* **a. Triple Down on Evergreen:** Expand the hyperlocal portfolio by identifying the top 3 high-demand, low-friction content verticals (e.g., Vlogs, Fitness Fails, Local Aesthetics) for each market (IN, ID, JP, KR).
* **b. Feature and Concept Integration Mandate:** Mandate that all hyperlocal evergreen campaigns must be launched with a dedicated, low-friction creation feature (e.g., custom template, Al effect, or gallery upload functionality) to maximize conversion, mirroring the success of JP Photos.
* **c. Elevate Hyperlocal Audio Cadence:** Increase the frequency of UTS (KR) and MVR (IN) from bi-weekly to weekly refreshes in 2026, ensuring the FSI surface is continuously fed with fresh, locally relevant audio.
* **d. Dedicated Gamified IP Track:** Create a dedicated 2026 roadmap for 4-6 major, male-skewing global IP tentpoles (Gaming, Sports, Pop Culture) focused on interactive, gamified effect creation (e.g., skill-based games, AR challenges) for India and South Korea.
* **e. Indonesia Sports Pivot:** For Indonesia, pivot the Sports IP strategy away from competitive games (F1, Tennis) and towards content that mirrors local creation trends (humorous/candid fitness, "fit checks" for Padel/Pickleball), ensuring the effect/concept is locally resonant.

### 5. Lifecycle Retention/habit formation

* **a. The "Third" Segment:** We have cracked F18-34 (Easy creation: Templates) and M18-34 (Relevant Gaming/Sports IP). The 2026 battleground is Retention-turning these one-off creators into weekly actives via "Streak" mechanics.

---

## Market Deep Dives

### 1. India (IN): Key Results & Learnings

**Behavioral Theme:** Males engage with "Skill/Play"; Gen Pop engages with "Remix Culture."

**What Worked (The Drivers)**

* **Gamified Sports Activation (F1 BTM):**
    * **Why it Worked (Hypothesis):** Young Indian males reject "performative" creation (vlogs) but engage deeply with Skill-Based Gamification. The F1 effect turned creation into a "reflex challenge," bypassing the vanity barrier.
    * **Data Proof:** IN Global HB (July) Gen pop: +0.29%; Campaign HB: Male 18-24: +0.51%, Male 25-34: +0.36%, Male 18-34: +0.42%, Male GenPop: +0.22%.
* **Hyperlocal "Remix" Audio (MVR):**
    * **Why it Worked (Hypothesis):** Indian users prefer Transformative Creation ("Remix") over passive adoption ("Use This Sound"). MVR allows for "cultural co-creation."
    * **Data Proof:** IN Global HB (Oct/Nov) Gen pop (Oct: +0.22%, Nov: +0.21%), Gen pop 18-34 (Oct: +0.26%, Nov: +0.21%), Gen pop 18-24 (Oct: +0.42%, Nov: +0.37%), Gen pop Males (Oct: +0.2%, Nov: +0.18%), Gen pop 25-34 (Oct: +0.14%); Campaign HB: MVR2 over Oct- Nov (Gen pop: +0.12%, Gen pop 18-34: +0.11%, Gen pop 25-34: +0.13%).
* **Culturally "Deep" Verticals (Food/Arts):**
    * **Why it Worked (Hypothesis):** Low-Friction Authenticity. "Behind the scenes" cooking and "Dream Drawing Al" lowered the barrier for Gen Pop to share hobbies without needing high production value.
    * **Data Proof:** IN Global HB (Oct/Nov/Dec) Gen pop (Oct: +0.22%, Nov: +0.21%, Dec: +0.26%), Gen pop 18-34 (Oct: +0.26%, Nov: +0.21%, Dec: +0.2%), Gen pop 18-24 (Oct: +0.42%, Nov: +0.37%), Gen pop Males (Oct: +0.2%, Nov: +0.18%), Gen pop 25-34 (Oct: +0.14%); IN Global HB (July) Gen pop: +0.29%. Campaign HB: IN HL arts and craft (Gen pop: +0.12%, Gen pop males: +0.15%) and SSC2 (M18-34: +0.13%, Males 18-34: +0.13%) in Nov, HL food non Al (Gen pop 18-24: +0.12%), IN HL Travel CF1 (Female 25-34: +0.19%, Female 18-34: +0.14%)
* **Hyperlocal trend via Shorts "push" surface (SSC):**
    * **Why it Worked (Hypothesis):** "Push" (SSC) works for impulsive/bored mindsets (Males) for trend discovery and creation inspiration.
    * **Data Proof:** IN Global HB (Oct/Nov) Gen pop (Oct: +0.22%, Nov: +0.21%), Gen pop Males (Oct: +0.2%, Nov: +0.18%), Gen pop 18-34 (Oct: +0.26%, Nov: +0.21%), Gen pop 18-24 (Oct: +0.42%, Nov: +0.37%). Campaign HB: SSC2 M18-34: +0.13% in Nov.

**▼ What Didn't Work (The Drags)**

* **Generic Global "Tentpoles" (Taylor Swift):**
    * **Why it Failed:** Localization Mismatch. Global fame does not override high friction. The complex dance challenge and lack of hyper-local use-case lacked a "Cheat Code" (Template) for Indian users.
    * **Data Proof:** Taylor Swift BTM IN Female 18-24 -0.76%.
* **Generic "Authentic" Formats (OOTD/DIML):**
    * **Why it Failed:** Relevance Gap. Generic US-style prompts (Outfit of the Day/Day in my life) feel disconnected from the "Real India" user reality compared to hyper-specific cultural hooks.
    * **Data Proof:** Global Authentic Formats IN Male 25-34: -0.28%, IN GenPop 25-34: -0.22%, IN GenPop 18-34: -0.17%

### 2. Indonesia (ID): Key Results & Learnings

**Behavioral Theme:** Females need "Safe Fandom"; Males need "Hyper-Relevant IP."

**What Worked (The Drivers)**

* **Pre-Existing Asset Injection (Pets) and Skill Equalizer features:**
    * **Why it Worked (Hypothesis):** Zero-Friction Entry. Users already have pet photos in their gallery. Prompting them to upload existing assets removes the "Capture Anxiety." Select GenAl features (Veo 3) also helped reduce editing friction to upload.
    * **Data Proof:** ID HL Pets GenPop +0.16%, GenPop 25-34 +0.26%, GenPop 18-34 +0.23%, ID Global Gen Al - veo 31 (Dec): Female 18-34 +1.35%, Female GenPop +1%
* **Non-Dance x Easy feature K-Pop (Aespa/IDLE/BabyMonster):**
    * **Why it Worked (Hypothesis):** Inclusive Fandom. Pivot from "Dance" (High Skill) to "Transition/Effect" (Low Skill) allowed non-dancers to signal fandom identity.
    * **Data Proof:** ID Global Shorts holdback (Aug) Females 18-24 +1.13%, campaigns driving this: Aespa Kpop proactive: ID F25-34 +0.41%, IDLE Kpop proactive 1 ID F18-24 +0.51%, Baby Monster/ Le Sseraffim Kpop proactive 3 ID F18-34 +0.39%.
* **Pop Culture Alignment (Lady Gaga/Roblox):**
    * **Why it Worked (Hypothesis):** Identity Signaling. Wednesday Dance (Gaga) and Roblox aligned with specific subcultures (Horror/Gaming), driving identity-based creation.
    * **Data Proof:** Lady Gaga BTM ID Male 25-34 +0.80%, ID Male 18-34 +0.47%, ID Male GenPop +0.33%; Roblox ID F 25-34 +0.67%, ID F Gen pop +0.53%

**▼ What Didn't Work (The Drags)**

* **Cultural Disconnect - Misaligned Sports IP (F1/Tennis) or Category expression (Al drawing effect):**
    * **Why it Failed:** Cultural Disconnect. Unlike India, F1/Tennis are not "mass" in ID. The gamified effects failed because the underlying IP lacked cultural currency compared to local sports (Padle, Pickelball etc.). For scaled ID arts and craft, the way that it materializes in ID is more on the "Home DIY and craft" expression vs drawing random pictures with the Al drawing effect.
    * **Data Proof:** ID Global Shorts holdback (Aug) Males 18-24-0.5%, campaigns driving this: F1 Effect BTM (June to July) ID Male 25-34 -0.61%, ID Males 18-34-0.49%, ID Gen pop -0.28%. ID Global Shorts holdback (Sept) Males 18-24 -0.72%, campaigns driving this: US Tennis Open effect Male 25-34-0.59%, Genpop -0.21%. ID Arts & Crafts (Drawing effect): Female 25-34-0.32%, Female 18-34 -0.26%, Female GenPop -0.28%
* **Gender disconnect (Global scaled artist BTMs)**
    * **Why it failed:** Global Artist BTMs (Sabrina/Taylor) are only effective when they include a low-friction template or effect mechanic (e.g., Ed Sheeran's photo dump template) customised by local relevance, gender or be gender agnostic.
    * **Data proof:** ID Global Shorts holdback (Sept) Males 18-24 (-0.72%), campaigns driving this: Sabrina Carpenter BTM: Male 18-24 (-1.1%). ID Global Shorts holdback (Nov) Males 18-34 (-0.03%), campaigns driving this: Taylor Swift BTM: Female 25-34 (-0.48%), Male Gen pop (-0.39%) over Oct to Nov.
* **Interruptive Trends (Shelf 2):**
    * **Why it Failed:** Curatorial Failure. The specific hyper-local trend selection (Lip Sync/Dance) on Shelf 2 failed to resonate, causing negative sentiment, might be a result of strong competition in the market (Tik Tok).
    * **Data Proof:** ID Global Shorts holdback (Nov) Males 18-34 (-0.03%), campaigns driving this: Shelf2 (Nov-Dec): Male 18-24 -0.65%, Male GenPop -0.36%, GenPop 18-24-0.55%, Gen pop -0.23%
* **Saturated Cultural Tentpole**
    * **Why it Failed:** Potentially due to poor timing (creation peaked later during the campaign during the celebration and holidays of Ramadan, versus at the first half of the campaign during the fasting period) or the inability to have a highly differentiated creative during such a saturated cultural tentpole due to strong competitive marketing activity from Tik Tok or Instagram in Indonesia.
    * **Data Proof:** ID Ramadan Gen pop 25-34 (-0.23%), Gen pop 18-34 (-0.2%).

### 3. Japan (JP): Key Results & Learnings

**Behavioral Theme:** The "Aesthetic Shield" and "Local Concept" Fit is mandatory; Interruptions are rejected.

**What Worked (The Drivers)**

* **The "Aesthetic Shield" (HL Photos):**
    * **Why it Worked (Hypothesis):** Privacy by Design. JP users fear showing faces ("Face Reveal Anxiety"). High-fidelity "Faceless" templates (vlogs, fashion fit checks, cafe highlights, not showing faces etc) provided a safety shield. The Winter proactive was also effective with Male/Female GenPop in Japan with the consistent application of low friction templates (photo uploads, templates) matched with a relevant local seasonal moment like Winter.
    * **Data Proof:** JP Global Shorts Holdback (July): Female 18-24 +1.19%, Gen pop +0.95%, Aug: Female 18-24 +3.3%, Sept: Female 18-24 +4.15%, Gen pop 18-24 +2.9%, campaign driving this: JP HL photos (April to Oct): JP Females 18-24 +2.88%, JP Females 18-34 +1.7%, JP Gen pop 18-24 +1.29%, JP Gen pop 18-34 +1.1%. JP Global Shorts Holdback (Dec): Male GenPop +0.91%, campaign driving this: Winter proactive (Templates/Photos): Male Genpop +1.08%, Female GenPop +1.8%, GenPop +0.77%
* **Pull Discovery (Shelf):**
    * **Why it Worked (Hypothesis):** Deliberate Intent. Japanese users prefer to opt-in to trends (Shelf) rather than have them forced into their Shorts feed. Inclusion of hyperlocal artists and expansion of trend use cases beyond dance (from illustration, to gaming, Pets, Lip Syncs and Transitions) also helped.
    * **Data Proof:** JP Global Shorts Holdback (July): Female 18-24 +1.19%, Gen pop +0.95%, Aug: Female 18-24 +3.3%, Sept: Female 18-24 +4.15%, Gen pop 18-24 +2.9%, campaign driving this, Shelf1 (April to Oct): JP Females 18-34 (+1.5%), JP Gen pop 25-34 (+0.99%)
* **Localized Global Kpop/Artist BTM with low friction templates and female customisation:**
    * **Why it Worked (Hypothesis):** Concept Fit. The Ed Sheeran campaign didn't ask for a dance; it asked for a "Travel Photo Dump, reminiscing memories" (matching local behavior and creation use cases). Taylor Swift BTM 's usage of the template feature for the dance trend and the custom effect to give local users a "Showgirl" moment of their own, were all relevant to the Japanese local female, as seen from the success of Hyperlocal photos campaign which focuses on easy creation features. Aespa's artist-led non-dance (transition) trend creative helped provide expanded use cases for local users to create, beyond dance challenges, making it more relatable to Gen Pop Males.
    * **Data Proof:** JP Global Shorts Holdback (July): Female 18-24 +1.19%, Gen pop +0.95%, Aug: Female 18-24 +3.3%, Sept: Female 18-24 +4.15%, Gen pop 18-24 +2.9%, campaign driving this: ED Sheeran BTM (June to July): Females 18-34 +1.45%, Male Gen pop +0.88%, Gen Pop 25-34 +1.44%, Gen Pop 18-34 +1.12%, Aespa Non dance CF Kpop proactive (July): Male Gen Pop +0.9%. Taylor Swift BTM (Oct - Nov): JP Female Gen pop +1.99%.

**▼ What Didn't Work (The Drags)**

* **Interruptive Push (SSC):**
    * **Why it Failed:** Format Friction. Inserting trends into the viewing feed (SSC) is perceived as "noise" by deliberate JP users, leading to active rejection vs the success of Shelf for Japan.
    * **Data Proof:** SSC1 (Apr to Nov): JP Female 18-34-1.07%, JP Female 25-34-1.6%, Gen pop 25-34-1.34%
* **Concept mismatch on Hyperlocal scaled creation (APAC Food effects)**
    * **Why it Failed:** Concept Disconnect. APAC custom cooking effect game ("Flip Pan Game") doesn't match with how food content comes to life locally in Japan (e.g. storytelling. highlighting cafe and restaurants with rich histories, while enjoying the food).
    * **Data Proof:** APAC Food effects (Aug): JP Gen pop -0.48%.
* **Video collage may be more inspiring than photo dumps on HL scaled creation (Autumn Non Al)**
    * **Why it Failed:** Concept Disconnect. The JP Autumn Non Al Hyperlocal assets only had language localization from the Korea assets, focused on static photo dumps, while the Al assets (both human and non-human) feature a collage of engaging videos, this might have led to the video collages being more engaging and inspiring to create vs the static photo dumps.
    * **Data Proof:** Autumn Non Al Hyperlocal scaled creation (Nov): JP Gen pop 25-34-0.9%, JP Gen pop 18-34-0.7%
* **Gender Mismatch or in-market competing hyper-local trending songs impacting Artist BTMs:**
    * **Why it Failed:** Alienation. The Taylor Swift "Showgirl" concept was too female-coded, actively alienating the JP Male segment without a generic variant. Stray Kids Proactive Campaign even with alternative creative concepts (e.g., featuring pets) for the "Ceremony" song and the established popularity of Stray Kids among Japanese females (evidenced by 86% female views on their channel and 80% on the song itself), may be attributed to competing trending songs from other artists, such as HANA and Snowman, which were highly popular during the same timeframe.
    * **Data Proof:** Taylor Swift BTM (Oct - Nov): JP Male 18-24-4.25%, JP Male 18-34-2.2%, JP Male Gen pop -1.68), Kpop1 (Stray Kids) (Sept): JP Females Gen pop -1.03%.

### 4. South Korea (KR): Key Results & Learnings

**Behavioral Theme:** High-Octane Gaming for Males; "Drumbeat" Audio and "Local Concept Fit" for Females.

**What Worked (The Drivers)**

* **Gamified "Hyper-Skill" (F1 BTM):**
    * **Why it Worked (Hypothesis):** Competitive Utility. Korean males engaged with the F1 effect not as "content" but as a "high score challenge" to beat peers.
    * **Data Proof:** F1 BTM (Jun - Jul): KR Male 18-24 (+7.73%), KR GenPop 18-24 (+2.79%) (Massive outlier).
* **Audio "Drumbeats" (UTS):**
    * **Why it Worked (Hypothesis):** Cognitive Ease. The "Use This Sound" (UTS) format simplifies the decision tree. Regular bi-weekly prompts built a predictable habit.
    * **Data Proof:** South Korea Global Shorts holdback (Oct): Female 25-34: +3.39%, Female 18-34: +2.55% and Female Gen pop: +1.23%, campaign driving this: UTS1 (Apr to Oct): Female 18-24: +1.83%, Female 25-34: +1.26%. South Korea Global Shorts holdback (Nov): Female 18-34: +2.54%, Female 25-34: +3.82%, Female Gen pop: +1.01%, campaign driving this: UTS2 (Nov to Dec): Female 18-34: +2.15%
* **Localized Global Artist BTM with low friction templates and female customisation:**
    * **Why it Worked (Hypothesis):** Concept Fit. The Alex Warren BTM template concept in particular that was anchored on "reminiscing fond memories" and the effect concept anchored on a simple photobooth collage, all relatable concepts for Korean young females to lower the barrier for creation.
    * **Data Proof:** Alex Warren BTM (Jul-Aug): KR Female GenPop (+1.31%).

**What Didn't Work (The Drags)**

* **Interruptive Push (SSC):**
    * **Why it Failed:** Similar to Japan, KR users rejected "forced" trends in the feed is perceived as "noise" by deliberate KR users, leading to active rejection.
    * **Data Proof:** South Korea Global Shorts holdback (Oct): Male GenPop: -1.29%, campaigns driving this: SSC1 (Apr- Oct): Campaign holdback Female 25-34 (-1.81%) and Female 18-34 (-1.34%).
* **Mainstream K-Pop (Aespa):**
    * **Why it Failed:** Saturation/Fatigue. Standard "Dance Challenges" amongst more mainstream Korean Kpop artists might be saturated in KR. Without a novel hook (like Alex Warren's photo template), they fail to drive incremental lift.
    * **Data Proof:** Aespa CF 1 (dance) (June): KR Gen pop -0.36%, Aespa CF2 (Non Dance) (July): KR Female 18-34-1.63%.
* **Misaligned Global "Tentpoles" (Sabrina):**
    * **Why it Failed:** Broad lift and scaled US/Global Artist campaigns (e.g. Sabrina), will need a dedicated pivot in strategy to hyper-localize content and concepts further for the Korean user (e.g. Alex Warren effects and template concepts are good examples that were relevant to the local user insight).
    * **Data Proof:** Sabrina BTM (Sept): Gen Pop 18-24-5.09%.

### 5. Rest of World (ROW): K-Pop Learnings

**Behavioral Theme:** Western markets reject "Inauthentic" localized efforts; LATAM/EMEA Males embrace "High-Production" Effects.

**What Worked (The Drivers)**

* **High-Production "Studio" Aesthetic with triple-variant creatives (easy effects, non-dance creatives and artist dance) (Brazil, Germany, Mexico, Indonesia):**
    * **Why it Worked (Hypothesis):** Aspiration vs. Imitation. Males in BR/DE and Females in Mexico, may not have wanted to dance, but they did want the "K-Pop Star Aesthetic." High-fidelity custom effects and non-dance creative variants, allowed them to embody the fandom of Aespa/IDLE without performing the choreography.
    * **Data Proof:** Aespa (Dirty Work) BTM: Brazil Male 25-34 +0.93%, Brazil Male 18-34 +0.77%, Brazil Male Gen pop +0.37%, Brazil Gen pop 25-34 +0.44%, Brazil Gen pop 18-34 +0.38%; Germany Gen Pop 25-34 +1.12%; Mexico Females 25-34 +0.87%. IDLE (Non-Dance) proactive: Brazil Female 25-34: +0.68%; Germany Male 18-24 +3.27%, Male 18-34 +1.57%; Indonesia Female 18-24 +0.51%.
* **Diversified "Cute" Culture (Brazil):**
    * **Why it Worked (Hypothesis):** Universal "Cute" Appeal. Stray Kids utilized a dual-variant strategy: "Pet UGC" (cats dancing) alongside the artist, another with the artist dance. This tapped into universal pet culture, transcending fandom barriers.
    * **Data Proof:** Stray Kids Proactive: Brazil Female Gen Pop +0.28%.

**▼ What Didn't Work (The Drags)**

* **Localization Failure (France & UK):**
    * **Why it Failed:** The "Uncanny Valley" of Localization. Despite high views (FR female views 66%, UK female views 66%), campaigns failed to drive DAU-SCT. Creatives may have felt "inauthentic" or forced to Western European users, unlike the organic uptake in LATAM.
    * **Data Proof:** Aespa (Dirty Work) BTM:, France Female 25-34: -1.99%, France Female 18-34: -1.38, UK Female Gen pop: -0.76%, Indonesia Female Gen pop: -0.28%
* **Male Gender Mismatch (US, Mexico, Japan):**
    * **Why it Failed:** Low Relevance. Aespa's Dirty Work song Male view share was lower in Mexico and US vs other markets (Mexico Male Views-38%, US song views-41%) and the creative for both Aespa and BabyMonster was purely "Girl Group Aesthetic" without a gender-neutral bridge (like Gaming/Tech) negatively impacting male population.
    * **Data Proof:** Aespa (Dirty Work) BTM: United States Male 18-34: -0.49%, Mexico Male 18-24: -2.04%, Mexico Male 18-34: -0.93%. BABYMONSTER proactive: Japan Male 25-34: -1.77%, Japan Male Gen pop: -0.72%, Japan Genpop 25-34: -1.13%

---

## Appendix

**Months with APAC (IN, ID, JP, KR) Stat sig positive DAU-SCT on Global Shorts holdback and Campaign drivers 2025**

* **April Global Holdback:** APAC Stat Sig Positive for Males 18-24 (+0.16%) and Males 18-34 (+0.07%).
    * **Campaign Evidence:** JP Hyperlocal Photos (F18-24 +2.88%, F18-34 +1.70%, Gen Pop 18-24 +1.29%, Gen Pop 18-34 +1.10%); JP Shelf1 (Apr - Oct) (F18-34 +1.50%, Gen Pop 25-34 +0.99%); ID HL Pets (Apr- Jul) (Gen Pop 25-34 +0.26%, Gen pop 18-34: +0.23%, Gen pop +0.16%); KR UTS1 (Apr-Oct) (F18-24 +1.83%, F25-34 +1.26%)
* **July Global Holdback:** APAC Stat Sig Positive for Gen Pop 18-34 (+0.28%) and Gen Pop (+0.27%).
    * **Campaign Evidence:** IN F1 BTM (M18-34 +0.42%); IN Travel CF1 (July - Aug) (F25-34 +0.19%, F18-34 +0.14%); ID HL Pets (Apr- July) (Gen pop 25-34 +0.26%, Gen pop 18-34(+0.23%, Gen pop +0.16%); ID Aespa (F25-34 +0.41%); JP HL Photos (Mar - Oct) (F18-24 +2.88%, F18-34 +1.70%, Gen Pop 18-24 +1.29%, Gen Pop 18-34 +1.10%; JP Shelf 1 (Apr-Oct) (F18-34+1.50%, Gen Pop 25-34 +0.99%; JP EdSheeran (June-July) (F18-34 +1.45%, Male Gen Pop +0.88%, Gen Pop 25-34 +1.44%, Gen Pop 18-34 +1.12%); JP Aespa Non Dance CF (M Gen Pop +0.90%); KR UTS1 (Apr-Oct) (F18-24 +1.83%, F25-34 +1.26%); KR F1 BTM (M18-24 +7.73%); KR Alex Warren (Female Gen Pop +1.31%).
* **October Global Holdback:** APAC Stat Sig Positive for Male 18-24 +0.41%, Male 25-34 +0.07%, Male 18-34 +0.21%, Male Gen pop +0.18%, Gen pop 18-24 +0.45%, Gen pop 25-34 +0.21%, Gen pop 18-34 +0.3, Gen pop +0.23%.
    * **Campaign Evidence:** IN MVR2 (Gen Pop +0.12%, Gen pop 25-34 +0.13%, Gen pop 18-34 +0.11%, Female 25-34 +0.26%, Female 18-34 +0.21%); IN HL Food Non-Al (Gen Pop 18-24 +0.12%); KR UTS1 (F18-24 +1.83%); ID Kpop proactive ROW3 (Oct - Dec) (Female 18-34 +0.39%); JP HL Photos (Mar - Oct) (Female 18-24 +2.88%, Female 18-34 +1.7%, Gen pop 18-24 +1.29%, Gen pop 18-34 +1.1%); JP Shelf 1 (Apr-Oct) (F18-34 +1.50%, Gen Pop 25-34 +0.99%); JP Taylor Swift BTM (Oct - Nov) (Female Gen pop +1.99%); KR UTS1 (Apr - Oct) (Female 18-24 +1.83%, Female 25-34 +1.26%)
* **November Global Holdback:** APAC Stat Sig Positive for Males 18-24 +0.38%, Male Gen pop +0.16%, Gen pop 18-24 +0.39%, Gen pop 18-34 +0.22%, Gen pop +0.2%.
    * **Campaign evidence:** IN MVR2 (Oct - Nov) (Female 25-34 +0.26%, Female 18-34 +0.21%, Gen pop 25-34 +0.13%, Gen pop 18-34+0.11%, Gen pop +0.12%); IN HL Food Non Al (Oct - Nov) (Gen pop 18-24 +0.12%); IN SSC2 (Nov - Dec) (Male 18-34 +0.13%); IN Arts & Craft (Nov - Dec) (Male Gen pop +0.15%, Gen pop +0.12%); ID Kpop proactive ROW3 (Oct - Dec) (Female 18-34 +0.39%); JP Taylor Swift BTM (Oct - Nov) (Female Gen pop +1.99%); KR UTS2 (Nov - Dec) (Female 18-34 +2.15%)
* **December Global Holdback:** APAC Stat Sig Positive for GenPop 18-34 +0.22% and GenPop +0.26%
    * **Campaign evidence:** IN Arts & Craft (Nov - Dec) (Male Gen pop +0.15%, Gen pop +0.12%); ID Global Gen Al - veo 31 (Dec) (Female 18-34 +1.35%, Female GenPop +1%); ID Kpop proactive ROW3 (Oct - Dec) (Female 18-34 +0.39%); JP Winter (Dec) (Female GenPop +1.8%, Male GenPop +1.08%, GenPop +0.77%)
`;

         const MANUAL_YEAR_AHEAD_CONTENT = `
# 2026 Shorts Experiment Learning Agenda

### Strategic Framework: Behavioral Levers for Scalable creation & Retention.

---

### Pillar 1: The "Ability" Lever (Frictionless Expression)
**Behavioral Mechanism:** Drastically reducing the "Time-to-Quality" ratio. Users have the intent but lack the skill/time to produce "socially acceptable" content.
**2026 Experiment:** "Asset-First" Creation. Shift from "Shoot New" to "Upload Old."
**Hypothesis:** If we provide high-fidelity templates that utilize pre-existing gallery assets (photos/videos), we unlock latent supply from "Lurker" segments (F18-34, Gen Pop) who fear poor production quality.

**Data Proof Points (Success Signals):**
* **Japan (Photos):** F18-24 **+2.88%**, F18-34 **+1.7%** (Global HB).
* **Indonesia (Pets):** Gen pop 25-34 **+0.26%**, ID Gen pop 18-34: **+0.23%**, ID Gen pop: **+0.26%**.
* **India (Travel):** F18-34 **+0.14%**.

---

### Pillar 2: The "Motivation" Lever (Gamification & Competition)
**Behavioral Mechanism:** Reframing "Creation" as "Play." Young males reject "performative" creation (vlogging/dancing) but engage deeply with "skill-based" interactions.
**2026 Experiment:** "Skill-Based" Interactive Effects. Pivot Sports/Gaming IP from passive viewing to active "challenges" (Reflex tests, Scores).
**Hypothesis:** If we anchor creation in gameplay mechanics (scores, challenges) tied to Sports/Gaming IP, we bypass the "vanity barrier" for M18-34.

**Data Proof Points (Success Signals):**
* **Korea (F1 BTM):** M18-24 **+7.73%** (Campaign HB).
* **India (F1 BTM):** M18-34 **+0.42%**, M18-24 **+0.51%**.
* **Indonesia (Roblox):** Female Gen Pop **+0.53%** (Gamification works for females too if IP aligns).

---

### Pillar 3: The "Identity" Lever (Fan Association without Performance)
**Behavioral Mechanism:** Lowering "Social Risk." Users want to signal fandom (Identity) but fear the social risk of performing complex tasks (Dancing).
**2026 Experiment:** The "Non-Dance" Mandate. All Music/IP campaigns must offer a "low-risk" path (Transition, Photo Dump, Tech Overlay) to allow fandom signaling without performance.
**Hypothesis:** If we offer non-dance variants (e.g., Tech overlays, Transitions), we expand the Total Addressable Market (TAM) of creators beyond "Core Fans" to Gen Pop and Males.

**Data Proof Points:**
* **Indonesia (K-Pop):** F18-34 **+0.39%** via non-dance fashion transitions/pets.
* **Japan (Aespa):** Male Gen Pop **+0.90%** via non-dance transition creative.
* **ROW Context:** Brazil Male 25-34 **+0.93%** (Aespa Custom Effect).

**Failure Signals (High Risk):**
* **Japan (Taylor Swift):** M18-24 **-4.25%** (High friction/Gender mismatch).
* **India (Taylor Swift):** F18-24 **-0.76%** (Generic BTM failed).

---

### Pillar 4: The "Trigger" Lever (Habit Formation)
**Behavioral Mechanism:** "Drumbeat" Consistency. Creation is a habit, not a one-off event. Regular, predictable triggers reduce the cognitive load of "deciding" to create.
**2026 Experiment:** High-Frequency Local Audio Cycles. Move from "Big Bang" drops to bi-weekly "Drumbeats" of Hyperlocal Audio (UTS/MVR) via high-visibility surfaces (FSI).
**Hypothesis:** Sustained, bi-weekly exposure to hyperlocal audio cues creates a pavlovian creation response, driving higher LTV than sporadic Global hits.

**Data Proof Points (Success Signals):**
* **Korea (UTS):** Sustained F18-34 **+2.15%** (Nov), F18-24 **+1.83%** (Apr-Oct).
* **India (MVR):** Gen Pop **+0.12%** (Oct-Nov).

---

### Pillar 5: The "Context" Lever (Push vs. Pull Discovery)
**Behavioral Mechanism:** Matching Mindset to Surface. "Push" (SSC) works for impulsive/bored mindsets (Males). "Pull" (Shelf) works for deliberate/seeking mindsets (Females/Mature Markets).
**2026 Experiment:** Surface Segmentation. Deprioritize "Interruptive" formats for sensitive segments; double down on "Discovery" formats.
**Hypothesis:** Aligning the discovery surface (Shelf vs. SSC) with the user's intent state (Browsing vs. Watching) eliminates negative sentiment and churn.

**Data Proof Points (Success Signals):**
* **Japan (Shelf):** F18-34 **+1.50%** (Shelf is valid "Pull").
* **India (SSC):** M18-34 **+0.13%** (SSC is valid "Push" for young males).

**Failure Signals:**
* **Japan (SSC):** F18-34 **-1.07%** (Interruptive).
* **Korea (SSC):** F25-34 **-1.81%** (Interruptive).

---

### Pillar 6: The "Retention" Lever (Solving Churn)
**Behavioral Mechanism:** The "Small Win" Loop. Activating a user once is easy, getting them back requires immediate reinforcement.
**2026 Experiment:** The "Streak" & "Remix" Loop.
**Hypothesis:** If we re-target a first-time creator within 7 days with a "Low Stakes" follow-up (e.g., "Remix your own video" or "Join Week 2 of this Challenge"), we reduce D30 churn.

---

### 2026 Experiment Hypothesis Summary

<table class="w-full border-collapse border border-gray-300 text-sm">
    <thead>
        <tr class="bg-gray-100">
            <th class="border border-gray-300 p-2 text-left">Strategic Pillar</th>
            <th class="border border-gray-300 p-2 text-left">Target Segment</th>
            <th class="border border-gray-300 p-2 text-left">2025 Insight</th>
            <th class="border border-gray-300 p-2 text-left">Experiment Title</th>
            <th class="border border-gray-300 p-2 text-left">Experiment Hypothesis</th>
        </tr>
    </thead>
    <tbody>
        <!-- Pillar: Retention Lever -->
        <tr>
            <td rowspan="2" class="border border-gray-300 p-2 font-bold bg-gray-50">1. Retention Lever (Solving Churn)</td>
            <td class="border border-gray-300 p-2">APAC Gen Pop</td>
            <td class="border border-gray-300 p-2">High churn followed "Spike" campaigns (Ramadan). First-time creators churn because second action feels too hard.</td>
            <td class="border border-gray-300 p-2">The "Smart Remix" Re-Trigger</td>
            <td class="border border-gray-300 p-2">IF we prompt a user to "Remix" their own top video within 7 days, THEN D30 retention will improve.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">IN/KR Gen Pop</td>
            <td class="border border-gray-300 p-2">High-freq audio programs like KR UTS (+2.15%) and IN MVR (+0.12%) drove sustained engagement.</td>
            <td class="border border-gray-300 p-2">Audio "Streak" Mechanics</td>
            <td class="border border-gray-300 p-2">IF we frame UTS/MVR as a "Weekly Challenge" (Create 1 of 3), THEN we increase creation frequency per user.</td>
        </tr>
        <!-- Pillar: Ability Lever -->
        <tr>
            <td rowspan="4" class="border border-gray-300 p-2 font-bold bg-gray-50">2. The "Ability" Lever (Frictionless Expression)</td>
            <td class="border border-gray-300 p-2">JP/IN Females 18-34</td>
            <td class="border border-gray-300 p-2">JP Photos (+2.88%) and ID Pets (+0.26%) remove quality barrier better than shooting new.</td>
            <td class="border border-gray-300 p-2">"Asset-First" GenAI Templates</td>
            <td class="border border-gray-300 p-2">IF launch high-fidelity templates for gallery assets, THEN scale F18-34 DAU-SCT by bypassing shoot friction.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">ID/JP Gen Pop</td>
            <td class="border border-gray-300 p-2">DAU-SCT spikes when asking users to upload existing assets rather than shoot new.</td>
            <td class="border border-gray-300 p-2">Gallery Mining "Memory" Prompts</td>
            <td class="border border-gray-300 p-2">IF proactively bundle user photos into drafts, THEN unlock time-poor segments.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">ID/KR/JP Gen Pop</td>
            <td class="border border-gray-300 p-2">Vertical Bridge (Pets x Pop) succeeded via Stray Kids in Brazil (+0.28%).</td>
            <td class="border border-gray-300 p-2">"Pet-Pop" Category Challenges</td>
            <td class="border border-gray-300 p-2">IF mandate Pet Variant for release, THEN bridge fandom gap.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">IN Gen Pop</td>
            <td class="border border-gray-300 p-2">Indian users preferred MVR (Remix) over UTS. IN users prefer "Collaborative Completion."</td>
            <td class="border border-gray-300 p-2">"Chain Reaction" Templates</td>
            <td class="border border-gray-300 p-2">IF launch "Finish this Skit" templates, THEN maximize Remix behavior (+0.12%) via Demand-based creation.</td>
        </tr>
        <!-- Pillar 3-5: Motivation -->
        <tr>
            <td rowspan="3" class="border border-gray-300 p-2 font-bold bg-gray-50">3-5. The "Motivation" Lever (Gamification/Validation)</td>
            <td class="border border-gray-300 p-2">IN/KR Males 18-34</td>
            <td class="border border-gray-300 p-2">KR F1 (+7.73%) proved interactive scores drive male creation.</td>
            <td class="border border-gray-300 p-2">Hyper Local Gamified Sports IP</td>
            <td class="border border-gray-300 p-2">IF replicate F1 gamified effect with local IP (Cricket), THEN activate Passive Males.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">JP/ROW Males 18-34</td>
            <td class="border border-gray-300 p-2">JP Males rejected games (-0.48%) but accepted Aespa (+0.90%).</td>
            <td class="border border-gray-300 p-2">Non-Gamified "Aesthetic" Effects</td>
            <td class="border border-gray-300 p-2">IF offer Aesthetic overlays (JRPG stats), THEN engage introverted male segments.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">IN/Emerging Markets</td>
            <td class="border border-gray-300 p-2">India Males rejected OOTD (-0.28%) but accepted Food (+0.12%).</td>
            <td class="border border-gray-300 p-2">"Hobby Hero" Prompts</td>
            <td class="border border-gray-300 p-2">IF replace generic prompts with "Micro-Skill" prompts, THEN reverse negative lift.</td>
        </tr>
        <!-- Pillar: Identity Lever -->
        <tr>
            <td rowspan="2" class="border border-gray-300 p-2 font-bold bg-gray-50">6. The "Identity" Lever (Fan Association)</td>
            <td class="border border-gray-300 p-2">ID/JP Gen Pop</td>
            <td class="border border-gray-300 p-2">Taylor Swift failed in JP (-4.25% Males); Aespa Non-Dance succeeded (+0.90%).</td>
            <td class="border border-gray-300 p-2">The Non-Dance K-Pop Mandate</td>
            <td class="border border-gray-300 p-2">IF mandate "Transition" variants for all briefs, THEN unlock "Silent Fan" segment (Gen Pop/Males).</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">IN/ID Males 18-34</td>
            <td class="border border-gray-300 p-2">Failure of Tennis IP ID (-0.61%) proved generic effects fail if underlying IP lacks currency.</td>
            <td class="border border-gray-300 p-2">Local Sports "Fit Check" Templates</td>
            <td class="border border-gray-300 p-2">IF pivot to sports they actually play (Badminton/Cricket), THEN fix negative lift in M25-34.</td>
        </tr>
        <!-- Pillar: Context Lever -->
        <tr>
            <td rowspan="2" class="border border-gray-300 p-2 font-bold bg-gray-50">8. The "Context" Lever (Push vs. Pull)</td>
            <td class="border border-gray-300 p-2">JP/KR Females 18-34</td>
            <td class="border border-gray-300 p-2">"Push" (SSC) caused active rejection in JP (-1.07%) and KR (-1.81%). "Pull" (Shelf) drove lift.</td>
            <td class="border border-gray-300 p-2">Shelf-Only Discovery Shift</td>
            <td class="border border-gray-300 p-2">IF migrate 100% of discovery for mature markets to Shelf, THEN eliminate negative sentiment.</td>
        </tr>
        <tr>
            <td class="border border-gray-300 p-2">IN Males 18-34</td>
            <td class="border border-gray-300 p-2">SSC drove lift (+0.13%) for Indian Males as a boredom buster, unlike deliberate seekers.</td>
            <td class="border border-gray-300 p-2">SSC "Impulse" Gaming Trends</td>
            <td class="border border-gray-300 p-2">IF dedicate SSC strictly to Gaming/Comedy, THEN maximize Boredom to Creation conversion.</td>
        </tr>
    </tbody>
</table>
`;

        // --- GLOBAL LOGIC ---
        let globalData = [], globalHoldbackData = [], globalKPopData = [], globalKPopDates = [];
        let repoCache = { 'repo_campaign': [], 'repo_holdback': [], 'repo_kpop': [] };
        let currentMetricView = 'both'; 

        // --- DATA PROCESSING FUNCTIONS ---
        function stripWhitespace(value) { return typeof value === 'string' ? value.trim() : value; }
        
        function parseSigValue(val) {
            if (!val) return 0;
            const str = String(val).replace(/[()]/g, '').trim(); 
            const num = parseFloat(str);
            if (isNaN(num)) return 0;
            if (num < 0) return -1;
            if (num > 0) return 1;
            return 0;
        }

        function getSignificanceClass(sigValue) {
            if (sigValue === -1) return 'color-sig-neg';
            if (sigValue === 1) return 'color-sig-pos';
            return 'color-sig-neutral';
        }

        function getColumnValue(row, possibleKeys) {
            for (const key of possibleKeys) {
                if (row[key] !== undefined) return row[key];
            }
            return undefined;
        }

        function getNormalizedCountryCode(raw) {
            if (!raw) return null;
            const r = raw.trim();
            if (['IN', 'India'].includes(r)) return 'IN';
            if (['ID', 'Indonesia'].includes(r)) return 'ID';
            if (['JP', 'Japan', 'JPN'].includes(r)) return 'JP';
            if (['KR', 'South Korea', 'SouthKorea', 'Korea'].includes(r)) return 'KR';
            if (['US', 'USA', 'United States'].includes(r)) return 'US';
            if (['BR', 'Brazil'].includes(r)) return 'BR';
            if (['MX', 'Mexico'].includes(r)) return 'MX';
            if (['DE', 'Germany'].includes(r)) return 'DE';
            if (['GB', 'UK', 'United Kingdom'].includes(r)) return 'GB';
            if (['FR', 'France'].includes(r)) return 'FR';
            return r;
        }

        function getCountryDisplayName(code) {
            const map = { 'IN': 'India', 'ID': 'Indonesia', 'JP': 'Japan', 'KR': 'South Korea', 'US': 'United States', 'BR': 'Brazil', 'MX': 'Mexico', 'DE': 'Germany', 'GB': 'United Kingdom', 'FR': 'France' };
            return map[code] || code;
        }

        function extractMonthFromFileName(fileName) {
            const lower = fileName.toLowerCase();
            let match = lower.match(/(\d{1,2})[_-](\d{4})/);
            if (match) return { month: MONTH_NAMES[parseInt(match[1]) - 1], year: match[2] };
            match = lower.match(/(\d{4})(\d{2})/);
            if (match) return { month: MONTH_NAMES[parseInt(match[2]) - 1], year: match[1] };
            for (let i = 0; i < 12; i++) {
                if (new RegExp(`\\b(${MONTH_NAMES[i].toLowerCase()}|${MONTH_NAMES[i].substring(0,3).toLowerCase()})\\b`, 'i').test(lower)) {
                    const ym = lower.match(/(\d{4})/);
                    return { month: MONTH_NAMES[i], year: ym ? ym[1] : '2025' };
                }
            }
            return { month: 'Unknown', year: 'Year' };
        }

        // --- RENDER FUNCTIONS ---
        function renderMarkdown(markdown, targetId) {
            if (!markdown) return;
            const targetElement = document.getElementById(targetId);
            if (!targetElement) return;
            let html = marked.parse(markdown);
            html = html.replace(/(\+\s*\d+(\.\d+)?%)/g, '<span class="sig-green">$1</span>');
            html = html.replace(/(-\s*\d+(\.\d+)?%)/g, '<span class="sig-red">$1</span>');
            targetElement.innerHTML = html;
        }

        function renderRepositoryUI() {
            let total = repoCache['repo_campaign'].length + repoCache['repo_holdback'].length + repoCache['repo_kpop'].length;
            const badge = document.getElementById('repo-count-badge');
            if(badge) badge.textContent = `${total} files saved`;
            
            const renderList = (cat, elemId) => {
                const list = repoCache[cat];
                const container = document.getElementById(elemId);
                if (!container) return;
                if (list.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 text-sm py-8">No saved files.</p>`; return; }
                let html = '<ul class="space-y-2">';
                list.forEach((file, idx) => {
                    html += `<li class="flex items-center justify-between bg-white p-3 rounded border border-gray-200 shadow-sm"><div class="flex items-center gap-3"><input type="checkbox" id="chk-${cat}-${idx}" class="repo-chk h-4 w-4 cursor-pointer" data-category="${cat}" data-index="${idx}"><div><label for="chk-${cat}-${idx}" class="text-sm font-medium text-gray-800 cursor-pointer select-none block">${file.name}</label><span class="text-xs text-gray-400">Added: ${file.date}</span></div></div><button onclick="deleteFromRepo('${cat}', ${idx})" class="text-gray-400 hover:text-red-500 transition">✕</button></li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            };
            renderList('repo_campaign', 'repo-campaign');
            renderList('repo_holdback', 'repo-holdback');
            renderList('repo_kpop', 'repo-kpop');
        }

        async function deleteFromRepo(category, index) {
            if (confirm("Remove file?")) {
                const item = repoCache[category][index];
                repoCache[category].splice(index, 1);
                if (item.id && window.deleteFromCloud) await window.deleteFromCloud(item.id);
                renderRepositoryUI();
            }
        }

        function processDataForCountry(data, targetCountryCode, dateData = []) {
            const campaignDateMap = new Map();
            const mapSources = dateData.length > 0 ? [data, dateData] : [data];
            mapSources.flat().forEach(row => {
                const camp = stripWhitespace(row['Campaign']);
                const rawC = stripWhitespace(row['Country'] || row['Region'] || row['Market']);
                const rowCode = getNormalizedCountryCode(rawC);
                if (camp && rowCode) {
                    const start = stripWhitespace(row['Start Date'] || row['Launch Date']);
                    const end = stripWhitespace(row['End Date']);
                    const key = rowCode + '_' + camp;
                    if (start || end) campaignDateMap.set(key, { start, end });
                }
            });

            const countryData = data.filter(row => {
                const rowCountry = stripWhitespace(row['Country']) || stripWhitespace(row['Region']) || stripWhitespace(row['Market']);
                const slice = stripWhitespace(row['Slice']);
                const normalizedCountry = getNormalizedCountryCode(rowCountry);
                if (normalizedCountry === 'KR' && stripWhitespace(row['Campaign']) === 'SSC2') return false;
                const rawGender = stripWhitespace(row['Gender']);
                if (rawGender === 'unknown/others') return false; 
                return normalizedCountry === targetCountryCode && slice === 'Control';
            }).map(row => {
                return {
                    campaign: stripWhitespace(row['Campaign']),
                    country: targetCountryCode,
                    age: (stripWhitespace(row['Age']) === 'TOTAL' ? 'GenPop' : stripWhitespace(row['Age'])), 
                    gender: (stripWhitespace(row['Gender']) === 'TOTAL' ? 'GenPop' : stripWhitespace(row['Gender'])),
                    valueType: stripWhitespace(row['[Value Type]']),
                    'Shorts DAC-SCT': parseFloat(row['Shorts DAC-SCT']) || 0,
                    'Daily Shorts Creation Tool Active Users': parseFloat(row['Daily Shorts Creation Tool Active Users']) || 0,
                    row: row 
                };
            }).filter(row => row.campaign && row.age && row.gender);

            if (countryData.length === 0) return { finalTableData: [], sortedSegments: [], countryCode: targetCountryCode };
            
            const ratioData = countryData.filter(row => row.valueType === 'Ratio (%)');
            const groupedMap = new Map();
            const allSegments = new Set();
            
            ratioData.forEach(item => {
                const key = item.campaign + '__' + item.gender + '__' + item.age; 
                if (!groupedMap.has(key)) {
                    const dateKey = targetCountryCode + '_' + item.campaign;
                    const dates = campaignDateMap.get(dateKey) || { start: '', end: '' };
                    groupedMap.set(key, { sum_dac: 0, sum_dau: 0, count: 0, campaign: item.campaign, gender: item.gender, age: item.age, sig_dac: 0, sig_dau: 0, startDate: dates.start, endDate: dates.end });
                }
                const group = groupedMap.get(key);
                group.sum_dac += item['Shorts DAC-SCT']; group.sum_dau += item['Daily Shorts Creation Tool Active Users']; group.count += 1;
            });
            
            const sigData = countryData.filter(row => row.valueType === 'Trend Favorability');
            sigData.forEach(item => {
                const key = item.campaign + '__' + item.gender + '__' + item.age; 
                if (groupedMap.has(key)) {
                    const group = groupedMap.get(key);
                    const row = item.row;
                    let s_dau = parseSigValue(getColumnValue(row, ['Stat Sig_DAU_SCT', 'Stat Sig_Daily Shorts Creation Tool Active Users', 'Stat Sig_Daily Active Users', 'Stat Sig_Active Users']));
                    let s_dac = parseSigValue(getColumnValue(row, ['Stat Sig_DAC_SCT', 'Stat Sig_Shorts DAC-SCT']));
                    if (s_dau === 0) s_dau = parseSigValue(row[DAU_METRIC_COL_NAME]);
                    if (s_dac === 0) s_dac = parseSigValue(row[DAC_METRIC_COL_NAME]);
                    if (s_dau !== 0) group.sig_dau = s_dau;
                    if (s_dac !== 0) group.sig_dac = s_dac;
                }
            });

            const groupedArray = Array.from(groupedMap.values()).map(group => ({
                campaign: group.campaign, segment: group.gender + '_' + group.age,
                'DAU SCT Ratio (%)': (group.sum_dau / group.count).toFixed(2),
                'DAC SCT Ratio (%)': (group.sum_dac / group.count).toFixed(2),
                'Sig_DAU': group.sig_dau,
                'Sig_DAC': group.sig_dac,
                startDate: group.startDate, endDate: group.endDate
            }));

            const pivotedMap = new Map();
            groupedArray.forEach(item => {
                if (!pivotedMap.has(item.campaign)) pivotedMap.set(item.campaign, { Campaign: item.campaign, Country: targetCountryCode, 'Start Date': item.startDate, 'End Date': item.endDate });
                const seg = item.segment;
                pivotedMap.get(item.campaign)['DAU SCT Ratio (%)_' + seg] = item['DAU SCT Ratio (%)'];
                pivotedMap.get(item.campaign)['DAC SCT Ratio (%)_' + seg] = item['DAC SCT Ratio (%)'];
                pivotedMap.get(item.campaign)['Sig_DAU_' + seg] = item['Sig_DAU'];
                pivotedMap.get(item.campaign)['Sig_DAC_' + seg] = item['Sig_DAC'];
                allSegments.add(seg);
            });

            const finalTableData = Array.from(pivotedMap.values());
            finalTableData.sort((a, b) => {
                const getTimestamp = (dateStr) => { if (!dateStr || dateStr === '-' || dateStr === 'NA') return Infinity; const d = new Date(dateStr); return isNaN(d.getTime()) ? Infinity : d.getTime(); };
                return getTimestamp(a['Start Date']) - getTimestamp(b['Start Date']);
            });
            
            const sortedSegments = [];
            const CUSTOM_SEGMENT_ORDER = [];
            for (const gender of GENDER_ORDER) { for (const age of AGE_ORDER) { CUSTOM_SEGMENT_ORDER.push(gender + '_' + age); } }
            for (const customSegment of CUSTOM_SEGMENT_ORDER) { if (allSegments.has(customSegment)) sortedSegments.push(customSegment); }
            return { finalTableData, sortedSegments, countryCode: targetCountryCode };
        }

        function processHoldbackDataByCountryAndMonth(data) {
             if (data.length === 0) return { finalTableData: [], segments: [] };
             const groupedMap = new Map(); const allSegments = new Set();
             data.forEach(batch => {
                 const my = batch.month + ' ' + batch.year;
                 batch.data.forEach(row => {
                     let c = stripWhitespace(row['Country']||row['Region']||row['Market']||'Global');
                     if(c.toLowerCase()==='total' || c.toLowerCase()==='global') c = 'Global'; else if(c.toLowerCase()==='apac') c = 'APAC'; else { const norm = getNormalizedCountryCode(c); if(norm) c = getCountryDisplayName(norm); }
                     let g = stripWhitespace(row['Gender']); if(g==='unknown/others') g='Unknown'; else if(g==='TOTAL') g='GenPop';
                     let a = stripWhitespace(row['Age']); if(a==='TOTAL') a='GenPop';
                     if(stripWhitespace(row['Slice'])==='Control') {
                         const key = c + '__' + my + '__' + g + '__' + a;
                         if(!groupedMap.has(key)) groupedMap.set(key, { sum_dau:0, sum_dac:0, count:0, sig_dau:0, sig_dac:0, Country:c, Month:my, Gender:g, Age:a });
                         const grp = groupedMap.get(key);
                         const valType = stripWhitespace(row['[Value Type]']);
                         if(valType === 'Ratio (%)') {
                             grp.sum_dau += (parseFloat(row[DAU_METRIC_COL_NAME])||0);
                             grp.sum_dac += (parseFloat(row[DAC_METRIC_COL_NAME])||0);
                             grp.count++;
                         } else if (valType === 'Trend Favorability') {
                             let s_dau = parseSigValue(getColumnValue(row, ['Stat Sig_DAU_SCT', 'Stat Sig_Daily Shorts Creation Tool Active Users', 'Stat Sig_Daily Active Users', 'Stat Sig_Active Users']));
                             let s_dac = parseSigValue(getColumnValue(row, ['Stat Sig_DAC_SCT', 'Stat Sig_Shorts DAC-SCT']));
                             if(s_dau === 0) s_dau = parseSigValue(row[DAU_METRIC_COL_NAME]);
                             if(s_dac === 0) s_dac = parseSigValue(row[DAC_METRIC_COL_NAME]);
                             if(s_dau !== 0) grp.sig_dau = s_dau;
                             if(s_dac !== 0) grp.sig_dac = s_dac;
                         }
                     }
                 });
             });
             const groupedArray = Array.from(groupedMap.values()).map(g => { 
                 allSegments.add(g.Gender+'_'+g.Age); 
                 return { ...g, val_dau: g.count>0?(g.sum_dau/g.count).toFixed(2):'0.00', val_dac: g.count>0?(g.sum_dac/g.count).toFixed(2):'0.00' }; 
             });
             const pivoted = new Map();
             groupedArray.forEach(i => {
                 const k = i.Country+'__'+i.Month;
                 if(!pivoted.has(k)) pivoted.set(k, { Country: i.Country, Month: i.Month, sortKey: new Date(i.Month.replace(/(\w+) (\d{4})/, '$1 1, $2')) });
                 const sk = '('+i.Gender+'_'+i.Age+')';
                 pivoted.get(k)[DAU_METRIC_COL_NAME+'_'+sk] = i.val_dau; pivoted.get(k)[DAU_METRIC_COL_NAME+'_'+sk+'_sig'] = i.sig_dau;
                 pivoted.get(k)[DAC_METRIC_COL_NAME+'_'+sk] = i.val_dac; pivoted.get(k)[DAC_METRIC_COL_NAME+'_'+sk+'_sig'] = i.sig_dac;
             });
             const priority = ['India','Indonesia','Japan','South Korea','APAC','Global'];
             const final = Array.from(pivoted.values()).sort((a,b) => {
                 const pA = priority.indexOf(a.Country); const pB = priority.indexOf(b.Country);
                 if(pA!==-1 && pB!==-1) { if(pA!==pB) return pA-pB; } else if(pA!==-1) return -1; else if(pB!==-1) return 1; else if(a.Country!==b.Country) return a.Country.localeCompare(b.Country);
                 return a.sortKey - b.sortKey;
             });
             const sortedSegs = [];
             const GENDERS = GENDER_ORDER.concat(['Unknown']);
             for(const g of GENDERS) for(const a of AGE_ORDER) if(allSegments.has(g+'_'+a)) sortedSegs.push(g+'_'+a);
             return { finalTableData: final, segments: sortedSegs };
        }

        function renderCountryTable(processedData, containerId) {
            const { finalTableData, sortedSegments, countryCode } = processedData;
            const container = document.getElementById(containerId);
            if (!container) return;
            if (finalTableData.length === 0) { container.innerHTML = '<div class="p-4 bg-yellow-50 rounded text-yellow-800 border border-yellow-200">No data available.</div>'; return; }
            let html = '<div class="table-container shadow-sm"><table class="min-w-full divide-y divide-gray-200">';
            const segmentsByGender = sortedSegments.reduce((acc, segment) => {
                const [gender, ...ageParts] = segment.split('_'); const age = ageParts.join('_');
                if (!acc[gender]) acc[gender] = []; acc[gender].push(age); return acc;
            }, {});
            const spanMult = currentMetricView === 'both' ? 2 : 1;
            html += '<thead><tr><th class="px-6 py-3 sticky-col" rowspan="3" style="left:0; z-index:40; min-width:200px;">Campaign</th><th class="px-6 py-3" rowspan="3">Start</th><th class="px-6 py-3" rowspan="3">End</th>';
            GENDER_ORDER.forEach(g => { if(segmentsByGender[g]) html += `<th colspan="${segmentsByGender[g].length * spanMult}" class="text-center border-r border-gray-200">${g === 'GenPop' ? 'GenPop' : g}</th>`; });
            html += '</tr><tr>';
            GENDER_ORDER.forEach(g => { if(segmentsByGender[g]) segmentsByGender[g].forEach(a => html += `<th colspan="${spanMult}" class="px-2 py-1 text-center bg-blue-50 border-r border-blue-100 text-xs text-blue-800">${a === 'GenPop' ? 'GenPop' : a}</th>`); });
            html += '</tr><tr>';
            GENDER_ORDER.forEach(g => { if(segmentsByGender[g]) segmentsByGender[g].forEach(() => {
                if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<th class="px-2 py-1 text-center bg-blue-100 border-r border-white text-xs">DAU</th>`;
                if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<th class="px-2 py-1 text-center bg-green-100 border-r border-blue-200 text-xs">DAC</th>`;
            }); });
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            const exclusionList = COUNTRY_EXCLUSIONS[countryCode] || [];
            finalTableData.forEach((row, i) => {
                const rowClass = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += `<tr class="${rowClass} hover:bg-gray-100 transition-colors"><td class="px-6 py-3 sticky-col ${rowClass} font-medium text-gray-900" style="left:0; z-index:25;">${row.Campaign}</td><td class="px-6 py-3 text-gray-500">${row['Start Date']||'-'}</td><td class="px-6 py-3 text-gray-500">${row['End Date']||'-'}</td>`;
                sortedSegments.forEach(seg => {
                    const gender = seg.split('_')[0];
                    let valDAU = row['DAU SCT Ratio (%)_' + seg]; if (valDAU == null) valDAU = '0.00';
                    let valDAC = row['DAC SCT Ratio (%)_' + seg]; if (valDAC == null) valDAC = '0.00';
                    let sigDAU = row['Sig_DAU_' + seg]; let sigDAC = row['Sig_DAC_' + seg];
                    let clsDAU = 'px-3 py-3 text-center border-r border-white'; let clsDAC = 'px-3 py-3 text-center border-r border-gray-200';
                    if (gender === 'Male' && exclusionList.includes(row.Campaign)) { valDAU = "NA"; clsDAU += " color-na"; valDAC = "NA"; clsDAC += " color-na"; }
                    else { clsDAU += ' ' + getSignificanceClass(sigDAU); clsDAC += ' ' + getSignificanceClass(sigDAC); }
                    if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<td class="${clsDAU}">${valDAU}</td>`;
                    if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<td class="${clsDAC}">${valDAC}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderHoldbackTable(processedData, containerId) {
            const { finalTableData, segments } = processedData;
            const container = document.getElementById(containerId);
            if (!container) return;
            if (finalTableData.length === 0) { container.innerHTML = '<div class="p-4 bg-yellow-50 rounded text-yellow-800 border border-yellow-200">No Global Holdback Data.</div>'; return; }
            let html = '<div class="table-container shadow-sm"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 sticky-col" style="left:0; z-index:40;" rowspan="3">Country</th><th class="px-6 py-3 sticky-col" style="left:120px; z-index:40;" rowspan="3">Month</th>';
            const segmentsByGender = segments.reduce((acc, s) => { const g = s.split('_')[0]; if(!acc[g]) acc[g]=[]; acc[g].push(s); return acc; }, {});
            const GENDERS = Object.keys(segmentsByGender); 
            const spanMult = currentMetricView === 'both' ? 2 : 1;
            GENDERS.forEach(g => html += `<th colspan="${segmentsByGender[g].length * spanMult}" class="text-center border-r border-gray-200">${g}</th>`);
            html += '</tr><tr>';
            GENDERS.forEach(g => segmentsByGender[g].forEach(s => html += `<th colspan="${spanMult}" class="text-center bg-blue-50 border-r border-blue-100 text-xs text-blue-800">${s.split('_').slice(1).join('_')}</th>`));
            html += '</tr><tr>';
            GENDERS.forEach(g => segmentsByGender[g].forEach(() => {
                if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<th class="text-center bg-blue-100 border-r border-white text-xs">DAU</th>`;
                if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<th class="text-center bg-green-100 border-r border-blue-200 text-xs">DAC</th>`;
            }));
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            let lastC = null; const counts={}; finalTableData.forEach(r => counts[r.Country]=(counts[r.Country]||0)+1);
            finalTableData.forEach((row, i) => {
                const cls = i%2===0?'bg-white':'bg-gray-50';
                html += `<tr class="${cls}">`;
                if(row.Country!==lastC) { html += `<td rowspan="${counts[row.Country]}" class="px-6 py-3 sticky-col font-bold text-gray-700 bg-white border-r border-gray-200" style="left:0; z-index:25; vertical-align:top;">${row.Country}</td>`; lastC=row.Country; }
                html += `<td class="px-6 py-3 sticky-col ${cls} border-r border-gray-200 text-gray-600" style="left:120px; z-index:25;">${row.Month}</td>`;
                segments.forEach(s => {
                    const sk = '('+s+')';
                    const colDAU = DAU_METRIC_COL_NAME+'_'+sk; const colDAC = DAC_METRIC_COL_NAME+'_'+sk;
                    const valDAU = row[colDAU] || '0.00'; const valDAC = row[colDAC] || '0.00';
                    const sigDAU = row[colDAU+'_sig']; const sigDAC = row[colDAC+'_sig'];
                    if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<td class="px-3 py-3 text-center border-r border-white ${getSignificanceClass(sigDAU)}">${valDAU}</td>`;
                    if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<td class="px-3 py-3 text-center border-r border-gray-100 ${getSignificanceClass(sigDAC)}">${valDAC}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderKPopTable(rows, segments, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (rows.length === 0) { container.innerHTML = '<p>No K-Pop data found.</p>'; return; }
            const countryPriority = ['Indonesia', 'United States', 'Brazil', 'Japan', 'Mexico', 'Germany', 'France', 'India', 'United Kingdom'];
            rows.sort((a, b) => {
                const idxA = countryPriority.indexOf(a.CountryName); const idxB = countryPriority.indexOf(b.CountryName);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB; if (idxA !== -1) return -1; if (idxB !== -1) return 1;
                return a.CountryName.localeCompare(b.CountryName);
            });
            const countryCounts = {}; rows.forEach(r => countryCounts[r.CountryName] = (countryCounts[r.CountryName] || 0) + 1);
            let html = '<div class="table-container shadow-sm"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 sticky-col" style="left:0; z-index:40;" rowspan="3">Market</th><th class="px-6 py-3 sticky-col" style="left:120px; z-index:40;" rowspan="3">Campaign</th><th class="px-6 py-3" rowspan="3">Start</th><th class="px-6 py-3" rowspan="3">End</th>';
            const segmentsByGender = segments.reduce((acc, s) => { const g = s.split('_')[0]; if(!acc[g]) acc[g]=[]; acc[g].push(s); return acc; }, {});
            const GENDERS = GENDER_ORDER.concat(['Unknown']);
            const spanMult = currentMetricView === 'both' ? 2 : 1;
            GENDERS.forEach(g => { if(segmentsByGender[g]) html += `<th colspan="${segmentsByGender[g].length * spanMult}" class="text-center border-r border-gray-200">${g}</th>`; });
            html += '</tr><tr>';
            GENDERS.forEach(g => { if(segmentsByGender[g]) segmentsByGender[g].forEach(s => html += `<th colspan="${spanMult}" class="text-center bg-blue-50 border-r border-blue-100 text-xs text-blue-800">${s.split('_').slice(1).join('_')}</th>`); });
            html += '</tr><tr>';
            GENDERS.forEach(g => { if(segmentsByGender[g]) segmentsByGender[g].forEach(() => {
                if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<th class="text-center bg-blue-100 border-r border-white text-xs">DAU</th>`;
                if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<th class="text-center bg-green-100 border-r border-blue-200 text-xs">DAC</th>`;
            }); });
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            let lastMarket = null;
            rows.forEach((row, i) => {
                const rowClass = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += `<tr class="${rowClass}">`;
                if (row.CountryName !== lastMarket) { html += `<td rowspan="${countryCounts[row.CountryName]}" class="px-6 py-3 sticky-col font-bold text-gray-700 bg-white border-r border-gray-200" style="left:0; z-index:25; vertical-align:top;">${row.CountryName}</td>`; lastMarket = row.CountryName; }
                html += `<td class="px-6 py-3 sticky-col ${rowClass} font-medium text-gray-900 border-r border-gray-200" style="left:120px; z-index:25;">${row.Campaign}</td><td class="px-6 py-3 text-gray-500">${row['Start Date']||'-'}</td><td class="px-6 py-3 text-gray-500">${row['End Date']||'-'}</td>`;
                segments.forEach(seg => {
                    const g = seg.split('_')[0];
                    let valDAU = row['DAU SCT Ratio (%)_' + seg] || '0.00'; let valDAC = row['DAC SCT Ratio (%)_' + seg] || '0.00';
                    const code = getNormalizedCountryCode(row.CountryName);
                    let clsDAU = 'px-3 py-3 text-center border-r border-white'; let clsDAC = 'px-3 py-3 text-center border-r border-gray-100';
                    if (g === 'Male' && code && COUNTRY_EXCLUSIONS[code] && COUNTRY_EXCLUSIONS[code].includes(row.Campaign)) { valDAU="NA"; clsDAU+=" color-na"; valDAC="NA"; clsDAC+=" color-na"; }
                    else { clsDAU += ' ' + getSignificanceClass(row['Sig_DAU_' + seg]); clsDAC += ' ' + getSignificanceClass(row['Sig_DAC_' + seg]); }
                    if(currentMetricView === 'both' || currentMetricView === 'dau') html += `<td class="${clsDAU}">${valDAU}</td>`;
                    if(currentMetricView === 'both' || currentMetricView === 'dac') html += `<td class="${clsDAC}">${valDAC}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // --- CORE LOGIC PHASES ---

        function runCampaignPhase(data) {
            const container = document.getElementById('summary-output');
            if(!container) return;
            container.innerHTML = `<div class="space-y-6"><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-6"><button onclick="switchSubTab('india')" id="sub-btn-india" class="sub-tab-btn active font-medium text-blue-600 border-blue-600 px-1 py-4 border-b-2">India</button><button onclick="switchSubTab('indonesia')" id="sub-btn-indonesia" class="sub-tab-btn font-medium text-gray-500 border-transparent px-1 py-4 border-b-2">Indonesia</button><button onclick="switchTab('tab5')" class="sub-tab-btn font-medium text-gray-500 px-1 py-4 border-b-2">K-Pop View</button><button onclick="switchSubTab('japan')" id="sub-btn-japan" class="sub-tab-btn font-medium text-gray-500 border-transparent px-1 py-4 border-b-2">Japan</button><button onclick="switchSubTab('southkorea')" id="sub-btn-southkorea" class="sub-tab-btn font-medium text-gray-500 border-transparent px-1 py-4 border-b-2">South Korea</button></nav></div><div id="sub-content-india" class="sub-tab-content active fade-in"></div><div id="sub-content-indonesia" class="sub-tab-content fade-in"></div><div id="sub-content-japan" class="sub-tab-content fade-in"></div><div id="sub-content-southkorea" class="sub-tab-content fade-in"></div></div>`;
            
            renderCountryTable(processDataForCountry(data, 'IN'), 'sub-content-india');
            renderCountryTable(processDataForCountry(data, 'ID'), 'sub-content-indonesia');
            renderCountryTable(processDataForCountry(data, 'JP'), 'sub-content-japan');
            renderCountryTable(processDataForCountry(data, 'KR'), 'sub-content-southkorea');
        }

        function runKPopPhase(data, dates) {
            const countriesFound = new Set();
            data.forEach(row => { const raw = stripWhitespace(row['Country']||row['Region']||row['Market']); if(raw) { const n = getNormalizedCountryCode(raw); if(n) countriesFound.add(n); } });
            let combinedRows = []; let allSegmentsSet = new Set();
            countriesFound.forEach(code => {
                const res = processDataForCountry(data, code, dates);
                if (res.finalTableData.length > 0) {
                    const rowsWithFullName = res.finalTableData.map(r => { r.CountryName = getCountryDisplayName(code); return r; });
                    combinedRows = combinedRows.concat(rowsWithFullName);
                    res.sortedSegments.forEach(s => allSegmentsSet.add(s));
                }
            });
            combinedRows = combinedRows.filter(row => !(!row['Start Date'] && !row['End Date']));
            const CUSTOM_SEGMENT_ORDER = []; const GENDERS_PLUS = [...GENDER_ORDER, 'Unknown']; 
            for (const gender of GENDERS_PLUS) for (const age of AGE_ORDER) CUSTOM_SEGMENT_ORDER.push(gender + '_' + age);
            const sortedSegments = CUSTOM_SEGMENT_ORDER.filter(segment => allSegmentsSet.has(segment));
            renderKPopTable(combinedRows, sortedSegments, 'kpop-summary-output');
        }

        async function finishProcessing(isFromStorage = false) {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            const indicator = document.getElementById('data-source-indicator');
            if(indicator) indicator.textContent = isFromStorage ? "Restored from session/repo" : "Live data update";
            
            if (typeof window.localforage !== 'undefined') {
                try { await Promise.all([ window.localforage.setItem('globalData', globalData), window.localforage.setItem('globalHoldbackData', globalHoldbackData), window.localforage.setItem('globalKPopData', globalKPopData), window.localforage.setItem('globalKPopDates', globalKPopDates) ]); } catch (e) {}
            }
            runCampaignPhase(globalData);
            if(globalHoldbackData.length > 0) renderHoldbackTable(processHoldbackDataByCountryAndMonth(globalHoldbackData), 'holdback-summary-output');
            if(globalKPopData.length > 0) runKPopPhase(globalKPopData, globalKPopDates);
            renderMarkdown(MANUAL_LEARNINGS_CONTENT, 'learnings-output');
            renderMarkdown(MANUAL_YEAR_AHEAD_CONTENT, 'year-ahead-output');
        }

        async function loadDataFromStorage() {
             try {
                const [gData, gHBData, gKPop, gKPopDates] = await Promise.all([
                    localforage.getItem('globalData'), localforage.getItem('globalHoldbackData'), localforage.getItem('globalKPopData'), localforage.getItem('globalKPopDates')
                ]);
                if (gData && gData.length > 0) {
                    globalData = gData; globalHoldbackData = gHBData || []; globalKPopData = gKPop || []; globalKPopDates = gKPopDates || [];
                    finishProcessing(true); 
                } else { document.getElementById('upload-section').classList.remove('hidden'); }
            } catch (e) { document.getElementById('upload-section').classList.remove('hidden'); }
            
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        function processFiles() {
            const cFiles = Array.from(document.getElementById('campaignFileInput').files);
            const hFiles = Array.from(document.getElementById('holdbackFileInput').files);
            const kFiles = Array.from(document.getElementById('kpopFileInput').files);
            
            const getRepoFiles = (cat) => {
                const selected = [];
                if (repoCache && repoCache[cat]) repoCache[cat].forEach((file, idx) => { if (document.getElementById(`chk-${cat}-${idx}`)?.checked) selected.push(file); });
                return selected;
            };
            const cRepo = getRepoFiles('repo_campaign'), hRepo = getRepoFiles('repo_holdback'), kRepo = getRepoFiles('repo_kpop');

            if (cFiles.length + hFiles.length + kFiles.length + cRepo.length + hRepo.length + kRepo.length === 0) { finishProcessing(false); return; }
            const statusMsg = document.getElementById('status-msg');
            statusMsg.textContent = "Processing and saving files...";
            globalData = []; globalHoldbackData = []; globalKPopData = []; globalKPopDates = [];
            let processedCount = 0;
            let totalToProcess = cFiles.length + hFiles.length + kFiles.length + cRepo.length + hRepo.length + kRepo.length;
            const checkDone = () => { processedCount++; if (processedCount >= totalToProcess) { renderRepositoryUI(); finishProcessing(false); } };
            
            const processFileItem = (item, type, isRepo) => {
                const name = item.name.toLowerCase();
                const content = isRepo ? item.content : item; 
                const handleParse = (results) => {
                    const data = results.data;
                    if (type === 'campaign') globalData = globalData.concat(data);
                    else if (type === 'holdback') { const { month, year } = extractMonthFromFileName(item.name); globalHoldbackData.push({ data, month, year }); }
                    else if (type === 'kpop') { if (name.includes('date')) globalKPopDates = globalKPopDates.concat(data); else globalKPopData = globalKPopData.concat(data); }
                    
                    // Trigger cloud save if it's a new upload
                    if (!isRepo && name.endsWith('.csv') && window.saveToCloud) {
                        let cat = type === 'holdback' ? 'repo_holdback' : type === 'kpop' ? 'repo_kpop' : 'repo_campaign';
                        window.saveToCloud({ name: item.name, content: Papa.unparse(data), type: 'csv' }, cat);
                    }
                    checkDone();
                };
                if (name.endsWith('.csv')) Papa.parse(content, { header: true, skipEmptyLines: true, complete: handleParse });
                else checkDone(); 
            };
            cFiles.forEach(f => processFileItem(f, 'campaign', false)); hFiles.forEach(f => processFileItem(f, 'holdback', false)); kFiles.forEach(f => processFileItem(f, 'kpop', false));
            cRepo.forEach(f => processFileItem(f, 'campaign', true)); hRepo.forEach(f => processFileItem(f, 'holdback', true)); kRepo.forEach(f => processFileItem(f, 'kpop', true));
        }

        // NAVIGATION & UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            const btn = document.getElementById('btn-' + tabId);
            if(btn) btn.classList.add('active');
        }

        function switchSubTab(country) {
            document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active', 'border-blue-600', 'text-blue-600'));
            const content = document.getElementById('sub-content-' + country);
            if(content) content.classList.add('active');
            const btn = document.getElementById('sub-btn-' + country);
            if(btn) btn.classList.add('active', 'border-blue-600', 'text-blue-600');
        }

        function switchRepoTab(repoId) {
            document.querySelectorAll('.repo-tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.repo-tab-btn').forEach(el => el.classList.remove('active'));
            const content = document.getElementById(repoId);
            if(content) content.classList.add('active');
            const btn = document.getElementById(`btn-${repoId}`);
            if(btn) btn.classList.add('active');
        }

        function showUploadSection() {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            renderRepositoryUI();
        }

        function copyToClipboard(button, elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const range = document.createRange();
            range.selectNodeContents(el);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try { 
                document.execCommand('copy'); 
                const originalText = button.innerHTML;
                button.innerHTML = 'Copied!'; 
                setTimeout(() => { button.innerHTML = originalText; }, 2000); 
            } catch (err) {}
            selection.removeAllRanges();
        }

        // Exposing cache updater to global scope for Firebase listener
        window.updateRepoCacheFromCloud = (repoData) => {
            repoCache = repoData;
            renderRepositoryUI();
            const syncStatus = document.getElementById('sync-status');
            if(syncStatus) syncStatus.textContent = 'Repository Synced';
        };

        window.updateMetricView = (view) => {
            currentMetricView = view;
            document.querySelectorAll('.mv-btn').forEach(btn => {
                btn.className = 'mv-btn text-xs font-medium px-2 py-1 rounded text-gray-600 hover:bg-gray-100 transition';
            });
            const activeBtn = document.getElementById('mv-' + view);
            if(activeBtn) activeBtn.className = 'mv-btn text-xs font-medium px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition';

            if (globalData.length > 0) runCampaignPhase(globalData);
            if (globalHoldbackData.length > 0) renderHoldbackTable(processHoldbackDataByCountryAndMonth(globalHoldbackData), 'holdback-summary-output');
            if (globalKPopData.length > 0) runKPopPhase(globalKPopData, globalKPopDates);
        };

        window.onload = async function() {
            await loadDataFromStorage();
        };
    </script>
</body>
</html>

